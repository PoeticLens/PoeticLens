<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d4f5c">
    <title>Poetic Lens - Poetry Archive</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: url('https://i.ibb.co/DD2CvvhJ/492123195-122150141522568294-1437317788203308205-n.jpg') center/cover fixed, rgba(232, 245, 232, 0.9);
            min-height: 100vh;
            color: ##cc8aff;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(45, 80, 22, 0.3), rgba(90, 138, 58, 0.2));
            z-index: -1;
        }

        /* Navigation */
        nav {
            background: rgba(255, 182, 193, 0.9);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            color: #cc8aff;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-badge {
            width: 80px;
            height: 80px;
            background-image: url('https://cdn.leonardo.ai/users/550ed1ad-9fba-4d78-b281-b013ab57e8f0/generations/247c53c8-02f0-477a-8a24-6cf703ac8056/variations/Default_a_highly_detailed_expressive_and_interpretative_rough_0_247c53c8-02f0-477a-8a24-6cf703ac8056_0.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: randomSpin 8s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logo-badge:hover {
            animation: continuousSpin 1s linear infinite;
        }

        @keyframes randomSpin {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(0deg); }
            30% { transform: rotate(360deg); }
            50% { transform: rotate(360deg); }
            75% { transform: rotate(360deg); }
            80% { transform: rotate(720deg); }
            100% { transform: rotate(720deg); }
        }

        @keyframes continuousSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: none;
            border: 2px solid #cc8aff;
            color: #cc8aff;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-btn:hover {
            background: #cc8aff;
            color: #cc8aff;
            transform: translateY(-2px);
        }

        .nav-btn-leaf {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0;
            transform: scale(0.5) rotate(-45deg);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10;
        }

        .nav-btn:hover .nav-btn-leaf {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            animation: leafCycle 1.5s ease-in-out infinite;
        }

        @keyframes leafCycle {
            0%, 33% {
                background-image: url('https://cdn.leonardo.ai/users/550ed1ad-9fba-4d78-b281-b013ab57e8f0/generations/90eebbc0-16d8-416a-a0d5-b523d08a7f5c/variations/Default_A_vibrantly_colored_animated_leaf_with_intricate_veins_3_90eebbc0-16d8-416a-a0d5-b523d08a7f5c_0.png');
                transform: scale(1) rotate(0deg);
            }
            34%, 66% {
                background-image: url('https://cdn.leonardo.ai/users/550ed1ad-9fba-4d78-b281-b013ab57e8f0/generations/bfdb5525-80be-42a3-a089-8adf683db74a/variations/Default_A_vibrantly_colored_animated_leaf_with_intricate_veins_2_bfdb5525-80be-42a3-a089-8adf683db74a_0.png');
                transform: scale(1.1) rotate(120deg);
            }
            67%, 100% {
                background-image: url('https://cdn.leonardo.ai/users/550ed1ad-9fba-4d78-b281-b013ab57e8f0/generations/55365eb0-13d6-4127-92ae-43879ce919b3/variations/Default_A_vibrantly_colored_animated_leaf_with_intricate_veins_1_55365eb0-13d6-4127-92ae-43879ce919b3_0.png');
                transform: scale(1) rotate(240deg);
            }
        }

        /* Announcement bar */
        .announcement {
            background: #cc8aff;
            color: #cc8aff;
            text-align: center;
            padding: 0.5rem;
            margin-top: 70px;
            font-weight: bold;
        }

        /* Main content */
        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            min-height: calc(100vh - 120px);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }

        /* Page styles */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Introduction Page */
        .intro-page {
            text-align: center;
            padding: 4rem 2rem;
        }

        .intro-title {
            font-size: 3rem;
            color: #cc8aff;
            margin-bottom: 1rem;
            animation: fadeInUp 1s ease;
        }

        .intro-subtitle {
            font-size: 1.5rem;
            color: #cc8aff;
            margin-bottom: 2rem;
            animation: fadeInUp 1s ease 0.3s both;
        }

        .intro-text {
            font-size: 1.2rem;
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto 3rem;
            animation: fadeInUp 1s ease 0.6s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Book styles */
        .book-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 600px;
            perspective: 1000px;
        }

        .book {
            width: 400px;
            height: 600px;
            position: relative;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .book-cover {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('https://scontent-man2-1.xx.fbcdn.net/v/t39.30808-6/473536322_122131139258568294_4980249476269696459_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=833d8c&_nc_ohc=qsgWL_HARl8Q7kNvwGlaf5r&_nc_oc=AdlvA-zwuUeWBijtRPqC7_vEUcUN6_smQhT56TQQwuBp_mayMTm8mD7IQQ3K64tTwzfAYTMl1MSRSco65Rhlvt8z&_nc_zt=23&_nc_ht=scontent-man2-1.xx&_nc_gid=Zz_xRuMEy2Du4b9O0U2wWA&oh=00_AfP9wrA7XMGu4yiQ-Tn_jCd3REUyYYefKniZrr3YI2uuow&oe=6846B983') center/cover, #8B4513;
            border-radius: 8px;
            transform-origin: left;
            transition: transform 0.8s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            text-align: center;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            z-index: 2;
            opacity: 1;
        }

        .book.open .book-cover {
            transform: rotateY(-180deg);
        }

        .book-cover-content {
            position: relative;
            z-index: 3;
            transition: opacity 0.3s ease;
        }

        .book.open .book-cover-content {
            opacity: 0;
        }

        .book-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                rgba(139, 69, 19, 0.1) 0%,
                rgba(160, 82, 45, 0.05) 25%,
                rgba(139, 69, 19, 0.1) 50%,
                rgba(101, 67, 33, 0.05) 75%,
                rgba(139, 69, 19, 0.1) 100%
            );
            z-index: 1;
        }

        .book-cover > * {
            position: relative;
            z-index: 2;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
        }

        .book-cover h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            letter-spacing: 2px;
        }

        .book-cover h3 {
            font-size: 1.2rem;
            font-style: italic;
            margin-bottom: 2rem;
            opacity: 1;
        }

        .book-cover p {
            font-size: 0.9rem;
            opacity: 1;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .book-pages {
            position: absolute;
            width: 95%;
            height: 95%;
            background: #f9f9f9;
            border-radius: 0 8px 8px 0;
            left: 5%;
            top: 2.5%;
            padding: 2rem;
            overflow-y: auto;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease 0.3s;
            z-index: 1;
        }

        .book.open .book-pages {
            opacity: 1;
            visibility: visible;
        }

        .poetry-entry {
            margin-bottom: 3rem;
            padding: 1.5rem;
            border-left: 4px solid #cc8aff;
            background: rgba(125, 211, 252, 0.1);
            border-radius: 0 8px 8px 0;
        }

        .poetry-title {
            font-size: 1.3rem;
            color: #0d4f5c;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .poetry-content {
            line-height: 1.8;
            font-style: italic;
            white-space: pre-line;
        }

        .poetry-author {
            text-align: right;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #0891b2;
        }

        .poetry-image {
            width: 100%;
            max-width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Community Poetry Section */
        .community-poetry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }

        .community-poetry-header h2 {
            color: #0d4f5c;
            margin: 0;
        }

        .add-poetry-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .add-poetry-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .poetry-creation-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            margin-bottom: 2rem;
            display: none;
        }

        .poetry-creation-form.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Poetry Cards - Enhanced for Touch */
        .poetry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            padding: 1rem 0;
        }

        .poetry-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            border-left: 4px solid #7dd3fc;
            cursor: pointer;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .poetry-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.25);
            border-left-color: #0891b2;
        }

        .poetry-card:active {
            transform: translateY(-2px);
        }

        .poetry-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .poetry-card-title {
            font-size: 1.3rem;
            color: #0d4f5c;
            font-weight: bold;
            margin: 0;
            line-height: 1.3;
        }

        .poetry-card-author {
            color: #0891b2;
            font-style: italic;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .poetry-card-content {
            color: #2d5016;
            line-height: 1.6;
            margin-bottom: 1rem;
            max-height: 150px;
            overflow: hidden;
            position: relative;
            flex-grow: 1;
        }

        .poetry-card-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
            margin-left: 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .poetry-card-date {
            color: #6c757d;
            font-size: 0.8rem;
            margin-top: auto;
            text-align: right;
        }

        /* Forms - Enhanced for Mobile */
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #0d4f5c;
            font-weight: bold;
            font-size: 1rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #7dd3fc;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0891b2;
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }

        .form-group textarea {
            height: 150px;
            resize: vertical;
            min-height: 100px;
        }

        .submit-btn {
            background: #7dd3fc;
            color: #0d4f5c;
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-weight: 600;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .submit-btn:hover {
            background: #0891b2;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .submit-btn-leaf {
            position: absolute;
            top: -10px;
            right: 10px;
            width: 25px;
            height: 25px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0;
            transform: scale(0.5) rotate(-45deg);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10;
        }

        .submit-btn:hover .submit-btn-leaf {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            animation: leafCycle 1.5s ease-in-out infinite;
        }

        /* Image preview styles */
        .image-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            object-fit: cover;
        }

        .remove-image-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .remove-image-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* Shop styles - Enhanced for Mobile */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            min-height: 350px;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .shop-item:active {
            transform: translateY(-2px);
        }

        .shop-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .shop-item h3 {
            color: #0d4f5c;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
            line-height: 1.3;
        }

        .shop-item p {
            flex-grow: 1;
            margin-bottom: 1rem;
            line-height: 1.5;
            color: #2d5016;
        }

        .shop-item .price {
            font-size: 1.2rem;
            color: #7dd3fc;
            font-weight: bold;
            margin: 0.5rem 0;
            text-align: center;
            padding: 0.5rem;
            background: rgba(125, 211, 252, 0.1);
            border-radius: 8px;
        }

        .shop-item a {
            color: #0891b2;
            text-decoration: none;
            font-weight: 600;
            text-align: center;
            padding: 0.8rem;
            background: rgba(8, 145, 178, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-top: auto;
        }

        .shop-item a:hover {
            background: rgba(8, 145, 178, 0.2);
            transform: translateY(-1px);
        }

        /* Admin styles - Professional Dark Theme */
        .admin-panel {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 0;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            color: #e0e0e0;
        }

        .admin-header {
            background: linear-gradient(135deg, #263238, #37474f);
            color: #ffffff;
            padding: 2rem;
            text-align: center;
            border-bottom: 2px solid #455a64;
        }

        .admin-header h2 {
            margin: 0;
            font-size: 2rem;
            color: #ffffff;
        }

        .admin-header p {
            color: #b0bec5;
            margin: 0.5rem 0 0 0;
        }

        .admin-tabs {
            display: flex;
            background: #2c2c2c;
            border-bottom: 1px solid #404040;
            overflow-x: auto;
        }

        .admin-tab {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            color: #b0b0b0;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
            min-width: 150px;
            border-right: 1px solid #404040;
        }

        .admin-tab:hover {
            background: #3c3c3c;
            color: #ffffff;
        }

        .admin-tab.active {
            background: #1976d2;
            color: #ffffff;
            font-weight: bold;
        }

        .admin-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #2196f3;
        }

        .admin-tab-content {
            padding: 2rem;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
            background: #1e1e1e;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-form-section {
            background: #262626;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .admin-form-section h4 {
            color: #ffffff;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid #404040;
            padding-bottom: 0.5rem;
        }

        .admin-form-section .form-group {
            margin-bottom: 1rem;
        }

        .admin-form-section .form-group label {
            color: #b0b0b0;
            font-weight: normal;
            font-size: 0.9rem;
        }

        .admin-form-section .form-group input,
        .admin-form-section .form-group textarea {
            background: #333333;
            border: 1px solid #555555;
            color: #ffffff;
            padding: 0.8rem;
        }

        .admin-form-section .form-group input:focus,
        .admin-form-section .form-group textarea:focus {
            border-color: #2196f3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        .admin-form-section .submit-btn {
            background: #1976d2;
            color: #ffffff;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .admin-form-section .submit-btn:hover {
            background: #1565c0;
            transform: none;
        }

        .admin-items-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .admin-item-card {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .admin-item-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-color: #555555;
        }

        .admin-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .admin-item-title {
            font-weight: bold;
            color: #ffffff;
            margin: 0;
            font-size: 1.1rem;
        }

        .admin-item-author {
            color: #b0b0b0;
            font-style: italic;
            font-size: 0.85rem;
        }

        .admin-item-content {
            margin: 0.5rem 0;
            color: #d0d0d0;
            max-height: 100px;
            overflow: hidden;
            position: relative;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .admin-item-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            float: right;
            margin-left: 1rem;
            border: 1px solid #404040;
        }

        .admin-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .admin-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .admin-btn.edit {
            background: #ff9800;
            color: #ffffff;
        }

        .admin-btn.edit:hover {
            background: #f57c00;
        }

        .admin-btn.delete {
            background: #f44336;
            color: #ffffff;
        }

        .admin-btn.delete:hover {
            background: #d32f2f;
        }

        .admin-btn.save {
            background: #4caf50;
            color: #ffffff;
        }

        .admin-btn.save:hover {
            background: #388e3c;
        }

        .admin-btn.cancel {
            background: #757575;
            color: #ffffff;
        }

        .admin-btn.cancel:hover {
            background: #616161;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #1976d2, #2196f3);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #1565c0;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .logout-section {
            border-top: 1px solid #404040;
            padding: 1.5rem 2rem;
            background: #262626;
            text-align: center;
        }

        .logout-section .submit-btn {
            background: #f44336;
            color: #ffffff;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .logout-section .submit-btn:hover {
            background: #d32f2f;
            transform: none;
        }

        .tab-icon {
            margin-right: 0.5rem;
        }

        .cooldown-message {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        /* Security notification */
        .security-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #856404;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
            text-align: center;
        }

        /* Floating elements */
        .floating-elements {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: -1;
        }

        .floating-leaf {
            position: absolute;
            width: 60px;
            height: 60px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: float 8s ease-in-out infinite;
            opacity: 0.7;
        }

        .floating-leaf.leaf1 {
            background-image: url('https://cdn.leonardo.ai/users/550ed1ad-9fba-4d78-b281-b013ab57e8f0/generations/90eebbc0-16d8-416a-a0d5-b523d08a7f5c/variations/Default_A_vibrantly_colored_animated_leaf_with_intricate_veins_3_90eebbc0-16d8-416a-a0d5-b523d08a7f5c_0.png');
        }

        .floating-leaf.leaf2 {
            background-image: url('https://cdn.leonardo.ai/users/550ed1ad-9fba-4d78-b281-b013ab57e8f0/generations/bfdb5525-80be-42a3-a089-8adf683db74a/variations/Default_A_vibrantly_colored_animated_leaf_with_intricate_veins_2_bfdb5525-80be-42a3-a089-8adf683db74a_0.png');
        }

        .floating-leaf.leaf3 {
            background-image: url('https://cdn.leonardo.ai/users/550ed1ad-9fba-4d78-b281-b013ab57e8f0/generations/55365eb0-13d6-4127-92ae-43879ce919b3/variations/Default_A_vibrantly_colored_animated_leaf_with_intricate_veins_1_55365eb0-13d6-4127-92ae-43879ce919b3_0.png');
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg) scale(1); 
                opacity: 0.7;
            }
            25% { 
                transform: translateY(-15px) rotate(5deg) scale(1.1); 
                opacity: 0.8;
            }
            50% { 
                transform: translateY(-30px) rotate(10deg) scale(1); 
                opacity: 0.9;
            }
            75% { 
                transform: translateY(-15px) rotate(-5deg) scale(1.1); 
                opacity: 0.8;
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 120px;
            right: 20px;
            background: linear-gradient(135deg, #7dd3fc, #0891b2);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 1001;
            cursor: pointer;
            transform: translateX(400px);
            transition: all 0.5s ease;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification:hover {
            transform: translateX(0) scale(1.05);
            box-shadow: 0 12px 35px rgba(0,0,0,0.4);
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification-content {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .datastore-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .datastore-status.error {
            background: rgba(220, 53, 69, 0.9);
        }

        /* RESPONSIVE DESIGN - Mobile First Approach */
        
        /* Mobile Phones (320px - 480px) */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            
            nav {
                padding: 0.5rem 1rem;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .logo {
                font-size: 1.2rem;
                justify-content: center;
                gap: 0.5rem;
            }
            
            .logo-badge {
                width: 50px;
                height: 50px;
            }
            
            .nav-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
                width: 100%;
            }
            
            .nav-btn {
                padding: 0.7rem 0.5rem;
                font-size: 0.8rem;
                text-align: center;
                justify-content: center;
                min-height: 48px;
            }
            
            .announcement {
                margin-top: 140px;
                padding: 0.7rem;
                font-size: 0.9rem;
            }
            
            .main-content {
                padding: 1rem;
                margin-top: 1rem;
                border-radius: 10px;
            }
            
            .intro-page {
                padding: 2rem 1rem;
            }
            
            .intro-title {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }
            
            .intro-subtitle {
                font-size: 1.2rem;
                margin-bottom: 1.5rem;
            }
            
            .intro-text {
                font-size: 1rem;
                line-height: 1.6;
                margin-bottom: 2rem;
            }
            
            .book-container {
                min-height: 400px;
                padding: 1rem;
            }
            
            .book {
                width: 280px;
                height: 400px;
            }
            
            .book-cover h2 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .book-cover h3 {
                font-size: 1rem;
                margin-bottom: 1rem;
            }
            
            .book-pages {
                padding: 1rem;
                font-size: 0.9rem;
            }
            
            .poetry-entry {
                margin-bottom: 2rem;
                padding: 1rem;
            }
            
            .poetry-title {
                font-size: 1.1rem;
            }
            
            .poetry-image {
                max-width: 100%;
                height: 150px;
            }
            
            .community-poetry-header {
                flex-direction: column;
                gap: 1rem;
                padding: 0;
                text-align: center;
            }
            
            .add-poetry-btn {
                width: 100%;
                justify-content: center;
                padding: 1rem;
                font-size: 1rem;
            }
            
            .poetry-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0.5rem 0;
            }
            
            .poetry-card {
                padding: 1rem;
                border-radius: 10px;
            }
            
            .poetry-card-image {
                width: 60px;
                height: 45px;
                margin-left: 0.5rem;
            }
            
            .form-container {
                padding: 1.5rem;
                margin: 1rem;
                border-radius: 10px;
            }
            
            .form-group input,
            .form-group textarea {
                padding: 0.7rem;
                font-size: 1rem;
            }
            
            .submit-btn {
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
                min-height: 48px;
            }
            
            .shop-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem 0;
            }
            
            .shop-item {
                padding: 1rem;
                border-radius: 10px;
            }
            
            .floating-leaf {
                width: 40px;
                height: 40px;
            }
            
            .notification {
                right: 10px;
                top: 150px;
                max-width: calc(100vw - 20px);
                left: 10px;
                right: 10px;
                transform: translateY(-100px);
            }
            
            .notification.show {
                transform: translateY(0);
            }
            
            .datastore-status {
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
                border-radius: 10px;
            }
        }
        
        /* Large Mobile Phones & Small Tablets (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            nav {
                padding: 0.7rem 1.5rem;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .logo {
                font-size: 1.3rem;
                justify-content: center;
            }
            
            .logo-badge {
                width: 60px;
                height: 60px;
            }
            
            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.7rem;
                width: 100%;
            }
            
            .nav-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
                text-align: center;
                min-height: 46px;
            }
            
            .announcement {
                margin-top: 120px;
                padding: 0.8rem;
            }
            
            .main-content {
                padding: 1.5rem;
                margin-top: 1rem;
            }
            
            .intro-title {
                font-size: 2.5rem;
            }
            
            .intro-subtitle {
                font-size: 1.3rem;
            }
            
            .book {
                width: 320px;
                height: 480px;
            }
            
            .poetry-grid {
                grid-template-columns: 1fr;
                gap: 1.2rem;
            }
            
            .community-poetry-header {
                flex-direction: column;
                gap: 1rem;
                align-items: center;
            }
            
            .add-poetry-btn {
                width: auto;
                min-width: 200px;
            }
            
            .shop-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }
            
            .form-container {
                max-width: 90%;
                padding: 1.8rem;
            }
        }
        
        /* Tablets (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .nav-buttons {
                flex-wrap: wrap;
                gap: 0.8rem;
            }
            
            .nav-btn {
                font-size: 0.9rem;
                padding: 0.5rem 0.9rem;
            }
            
            .main-content {
                padding: 2rem 1.5rem;
            }
            
            .intro-title {
                font-size: 2.8rem;
            }
            
            .book {
                width: 350px;
                height: 520px;
            }
            
            .poetry-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.3rem;
            }
            
            .shop-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.8rem;
            }
            
            .form-container {
                max-width: 80%;
            }
        }
        
        /* Large Tablets & Small Desktops (1025px - 1200px) */
        @media (min-width: 1025px) and (max-width: 1200px) {
            .poetry-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .shop-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .nav-btn:hover,
            .submit-btn:hover,
            .add-poetry-btn:hover,
            .admin-btn:hover {
                transform: none;
            }
            
            .nav-btn:active,
            .submit-btn:active,
            .add-poetry-btn:active {
                transform: scale(0.95);
            }
            
            .poetry-card:hover {
                transform: none;
            }
            
            .poetry-card:active {
                transform: scale(0.98);
            }
            
            .shop-item:hover {
                transform: none;
            }
            
            .shop-item:active {
                transform: scale(0.98);
            }
            
            /* Disable complex animations on touch devices for better performance */
            .logo-badge:hover {
                animation: randomSpin 8s ease-in-out infinite;
            }
            
            .nav-btn-leaf,
            .submit-btn-leaf {
                display: none;
            }
        }
        
        /* High DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .logo-badge {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
            
            .poetry-image,
            .poetry-card-image,
            .admin-item-image {
                image-rendering: -webkit-optimize-contrast;
            }
        }
        
        /* Landscape Orientation on Mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .nav-container {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .logo {
                font-size: 1rem;
                gap: 0.5rem;
            }
            
            .logo-badge {
                width: 40px;
                height: 40px;
            }
            
            .nav-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                max-width: 60%;
            }
            
            .nav-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .announcement {
                margin-top: 80px;
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .intro-page {
                padding: 1.5rem 1rem;
            }
            
            .intro-title {
                font-size: 1.8rem;
            }
            
            .intro-subtitle {
                font-size: 1.1rem;
            }
            
            .book-container {
                min-height: 300px;
            }
            
            .book {
                width: 250px;
                height: 350px;
            }
        }
        
        /* Admin Panel Responsive Design */
        @media (max-width: 768px) {
            .admin-panel {
                margin: 1rem 0;
                border-radius: 10px;
            }
            
            .admin-tabs {
                flex-direction: row;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .admin-tab {
                min-width: 120px;
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
                border-right: 1px solid #404040;
            }
            
            .admin-tab-content {
                padding: 1rem;
                max-height: 60vh;
            }
            
            .admin-form-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .admin-form-section .form-group input,
            .admin-form-section .form-group textarea {
                padding: 0.7rem;
                font-size: 1rem;
            }
            
            .admin-buttons {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.5rem;
            }
            
            .admin-btn {
                padding: 0.6rem;
                font-size: 0.8rem;
                text-align: center;
                min-height: 44px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
                margin-bottom: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .admin-items-grid {
                gap: 0.8rem;
            }
            
            .admin-item-card {
                padding: 0.8rem;
            }
            
            .admin-item-image {
                width: 60px;
                height: 45px;
            }
        }

        @media (max-width: 768px) {
            .nav-buttons {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .intro-title {
                font-size: 2rem;
            }
            
            .book {
                width: 300px;
                height: 450px;
            }
            
            .main-content {
                padding: 1rem;
            }

            .poetry-grid {
                grid-template-columns: 1fr;
            }

            .community-poetry-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <!-- Floating elements -->
    <div class="floating-elements">
        <div class="floating-leaf leaf1" style="left: 5%; top: 10%; animation-delay: 0s;"></div>
        <div class="floating-leaf leaf2" style="left: 85%; top: 15%; animation-delay: 1s;"></div>
        <div class="floating-leaf leaf3" style="left: 15%; top: 60%; animation-delay: 2s;"></div>
        <div class="floating-leaf leaf1" style="left: 75%; top: 70%; animation-delay: 3s;"></div>
        <div class="floating-leaf leaf2" style="left: 25%; top: 25%; animation-delay: 4s;"></div>
        <div class="floating-leaf leaf3" style="left: 65%; top: 40%; animation-delay: 5s;"></div>
        <div class="floating-leaf leaf1" style="left: 45%; top: 80%; animation-delay: 6s;"></div>
        <div class="floating-leaf leaf2" style="left: 90%; top: 50%; animation-delay: 7s;"></div>
        <div class="floating-leaf leaf3" style="left: 10%; top: 35%; animation-delay: 8s;"></div>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <div class="logo-badge"></div>
                <span style="font-size: 46px; color: white; font-weight: bold; font-style: italic;">Poetic Lens</span>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" style="color: white; font-weight: bold; font-style: italic;" onclick="showPage('intro')">
                    Home
                    <div class="nav-btn-leaf"></div>
                </button>
                <button class="nav-btn" style="color: white; font-weight: bold; font-style: italic;" onclick="showPage('book')">
                    Poetic Lens Poetry
                    <div class="nav-btn-leaf"></div>
                </button>
                <button class="nav-btn" style="color: white; font-weight: bold; font-style: italic;" onclick="showPage('user-book')">
                    Community Poetry
                    <div class="nav-btn-leaf"></div>
                </button>
                <button class="nav-btn" style="color: white; font-weight: bold; font-style: italic;" onclick="showPage('submit')">
                    Submit Poetry
                    <div class="nav-btn-leaf"></div>
                </button>
                <button class="nav-btn" style="color: white; font-weight: bold; font-style: italic;" onclick="showPage('shop')">
                    Store
                    <div class="nav-btn-leaf"></div>
                </button>
                <button class="nav-btn" style="color: white; font-weight: bold; font-style: italic;" onclick="showPage('admin-login')">
                    Login
                    <div class="nav-btn-leaf"></div>
                </button>
            </div>
        </div>
    </nav>

    <!-- Announcement Bar -->
    <div class="announcement" id="announcement">
        Welcome to Poetic Lens - Where Nature Meets Words
    </div>

    <!-- Notification System -->
   <!-- <div id="notification" class="notification">
        <div class="notification-title" id="notification-title">
            <span id="notification-title-text">Poetry Added!</span>
        </div>
        <div class="notification-content" id="notification-content">
            Your poem has been added to the collection.
        </div>
    </div> -->

    <!-- Datastore Status -->
    <div id="datastore-status" class="datastore-status">
         Initializing...
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Introduction Page -->
        <div id="intro" class="page active">
            <div class="intro-page" style="font-style: italic;">
                <h1 class="intro-title" style="color: #010807;" style="font-size: 56px;">Libby Nessworthy</h1>
                <h2 class="intro-subtitle" style="color: #010807;" style="font-size: 46px;">Poet of Nature & Love</h2>
                <div class="intro-text" id="intro-text" style="color: white;" style="font-size: 36px;">
                ...
                </div>
            </div>
        </div>

        <!-- Poetry Book Page -->
        <div id="book" class="page">
            <!-- Poetic Lens Poetry Book Display -->
            <div class="book-container">
                <div class="book" id="poetry-book" onclick="toggleBook('poetry-book')">
                    <div class="book-cover">
                        <div class="book-cover-content">
                            <h2 style="color: #010807;">Libby Nessworthy</h2>
                            <h3 style="color: #010807;">Poetic Lens Archive</h3>
                            <p style="margin-top: 2rem; font-size: 1rem; opacity: 0; color: #010807;">Click to open</p>
                        </div>
                    </div>
                    <div class="book-pages" id="book-content">
                        <!-- Poetry entries will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Poetry Grid View -->
            <div class="poetry-grid" id="libby-poetry-grid">
                <!-- Libby's poetry cards will be populated here -->
            </div>
        </div>

        <!-- User Poetry Book Page -->
        <div id="user-book" class="page">
            <div class="community-poetry-header">
                <h2 style="color: #010807;">Community Poetry Collection</h2>
                <button class="add-poetry-btn" onclick="togglePoetryCreationForm()">
                     Add New Poetry
                </button>
            </div>

            <!-- Poetry Creation Form -->
            <div id="poetry-creation-form" class="poetry-creation-form">
                <h3 style="text-align: center; margin-bottom: 1.5rem; color: #0d4f5c;">Create New Poetry Entry</h3>
                <form id="community-poetry-form">
                    <div class="form-group">
                        <label for="community-poet-name">Author Name:</label>
                        <input type="text" id="community-poet-name" required>
                    </div>
                    <div class="form-group">
                        <label for="community-poem-title">Poem Title:</label>
                        <input type="text" id="community-poem-title" required>
                    </div>
                    <div class="form-group">
                        <label for="community-poem-content">Poem Content:</label>
                        <textarea id="community-poem-content" required placeholder="Share your beautiful words here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="community-poem-image">Add an Image (optional):</label>
                        <input type="file" id="community-poem-image" accept="image/*">
                        <div id="community-poem-image-preview" class="image-preview"></div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="submit-btn" style="background: #6c757d;" onclick="togglePoetryCreationForm()">
                            Cancel
                        </button>
                        <button type="submit" class="submit-btn">
                            Save Poetry 
                            <div class="submit-btn-leaf"></div>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Community Poetry Book Display -->
            <div class="book-container">
                <div class="book" id="user-poetry-book" onclick="toggleBook('user-poetry-book')">
                    <div class="book-cover">
                        <div class="book-cover-content">
                            <h2 style="color: #010807;">Community</h2>
                            <h3 style="color: #010807;">Poetry Collection</h3>
                            <p style="margin-top: 2rem; font-size: 1rem; color: #010807;">Click to open</p>
                        </div>
                    </div>
                    <div class="book-pages" id="user-book-content">
                        <!-- User poetry entries will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Poetry Grid View -->
            <div class="poetry-grid" id="poetry-grid">
                <!-- Poetry cards will be populated here -->
            </div>
        </div>

        <!-- Poetry Submission Page -->
        <div id="submit" class="page">
            <div class="form-container">
                <h2 style="text-align: center; margin-bottom: 2rem; color: #2d5016;">Share Your Poetry</h2>
                <div id="cooldown-notice" class="cooldown-message" style="display: none;">
                    Please wait before submitting another poem. Cooldown time remaining: <span id="cooldown-timer"></span>
                </div>
                <form id="poetry-form">
                    <div class="form-group">
                        <label for="poet-name">Your Name:</label>
                        <input type="text" id="poet-name" required>
                    </div>
                    <div class="form-group">
                        <label for="poem-title">Poem Title:</label>
                        <input type="text" id="poem-title" required>
                    </div>
                    <div class="form-group">
                        <label for="poem-content">Your Poem:</label>
                        <textarea id="poem-content" required placeholder="Share your beautiful words here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="poem-image">Add an Image (optional):</label>
                        <input type="file" id="poem-image" accept="image/*">
                        <div id="poem-image-preview" class="image-preview"></div>
                    </div>
                    <button type="submit" class="submit-btn">
                        Plant Your Poetry 
                        <div class="submit-btn-leaf"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- Shop Page -->
        <div id="shop" class="page">
            <h2 style="text-align: center; margin-bottom: 2rem; color: #2d5016;">Poetry Shop</h2>
            <div class="shop-grid" id="shop-items">
                <!-- Shop items will be populated here -->
            </div>
        </div>

        <!-- Admin Login Page -->
        <div id="admin-login" class="page">
            <div class="form-container">
                <h2 style="text-align: center; margin-bottom: 2rem; color: #2d5016;">Admin Login</h2>
                <div class="security-notice">
                     This admin panel uses enhanced security measures to protect against unauthorized access.
                </div>
                <form id="admin-login-form">
                    <div class="form-group">
                        <label for="admin-username">Username:</label>
                        <input type="text" id="admin-username" required>
                    </div>
                    <div class="form-group">
                        <label for="admin-password">Password:</label>
                        <input type="password" id="admin-password" required>
                    </div>
                    <button type="submit" class="submit-btn">
                        Login
                        <div class="submit-btn-leaf"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="page">
            <div class="admin-panel">
                <!-- Admin Header -->
                <div class="admin-header">
                    <h2>Administration Panel</h2>
                    <p>Professional content management with Firebase & localStorage</p>
                </div>
                
                <!-- Admin Tabs -->
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchAdminTab('overview', this)">
                        <span class="tab-icon"></span>Overview
                    </button>
                    <button class="admin-tab" onclick="switchAdminTab('libby-poetry', this)">
                        <span class="tab-icon"></span>Poetry Book
                    </button>
                    <button class="admin-tab" onclick="switchAdminTab('community-poetry', this)">
                        <span class="tab-icon"></span>Community Poetry Book
                    </button>
                    <button class="admin-tab" onclick="switchAdminTab('shop-items', this)">
                        <span class="tab-icon"></span>Store
                    </button>
                    <button class="admin-tab" onclick="switchAdminTab('settings', this)">
                        <span class="tab-icon"></span>Settings
                    </button>
                </div>

                <!-- Overview Tab -->
                <div id="admin-tab-overview" class="admin-tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="stat-libby-poems">0</span>
                            <span class="stat-label">Poetry Book</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="stat-community-poems">0</span>
                            <span class="stat-label">Community Poetry Book</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="stat-shop-items">0</span>
                            <span class="stat-label">Store</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="stat-total-content">0</span>
                            <span class="stat-label">Total Content</span>
                        </div>
                    </div>
                    
                    <div class="admin-form-section">
                        <h4>Quick Actions</h4>
                        <div class="admin-buttons">
                            <button class="admin-btn" style="background: #007bff; color: white;" onclick="switchAdminTab('libby-poetry')">
                                Add New Poem
                            </button>
                            <button class="admin-btn" style="background: #28a745; color: white;" onclick="switchAdminTab('shop-items')">
                                Add Shop Item
                            </button>
                            <button class="admin-btn" style="background: #ffc107; color: #212529;" onclick="switchAdminTab('settings')">
                                Update Settings
                            </button>
                        </div>
                    </div>

                    <div class="admin-form-section">
                        <h4> Collection Debugging Tools</h4>
                        <div style="margin-bottom: 1rem;">
                            <button class="admin-btn" style="background: #6f42c1; color: white;" onclick="debugCollections()">
                                 Debug Collections
                            </button>
                            <button class="admin-btn" style="background: #fd7e14; color: white;" onclick="clearLocalCollections()">
                                 Clear Local Data
                            </button>
                            <button class="admin-btn" style="background: #20c997; color: white;" onclick="loadFromFirebase()">
                                 Reload from Firebase
                            </button>
                        </div>
                        <div style="background: #333; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.8rem; color: #fff;">
                            <div> Debug info will appear in browser console</div>
                            <div> Check F12  Console for detailed logs</div>
                        </div>
                    </div>

                    <div class="admin-form-section">
                        <h4> Firebase & Local Storage Status</h4>
                        <div style="background: #333; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                            <div> Firebase: <span id="firebase-status" style="color: #ffc107;">Connecting...</span></div>
                            <div> Local Storage: <span style="color: #28a745;">Active</span></div>
                            <div> Network: <span id="network-status" style="color: #28a745;">Online</span></div>
                            <div style="margin: 0.5rem 0; border-top: 1px solid #555; padding-top: 0.5rem;">
                                <div>Libby Poetry: <span id="datastore-libby-count">0</span> entries</div>
                                <div>Community Poetry: <span id="datastore-community-count">0</span> entries</div>
                                <div>Shop Items: <span id="datastore-shop-count">0</span> entries</div>
                                <div> Settings: <span id="datastore-settings-count">0</span> configurations</div>
                            </div>
                            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #555;">
                                <strong>Status: <span id="datastore-status-text" style="color: #28a745;">Ready</span></strong>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="admin-btn" style="background: #17a2b8; color: white;" onclick="checkFirebaseHealth()">
                                Check Firebase Health
                            </button>
                            <button class="admin-btn" style="background: #6f42c1; color: white;" onclick="exportData()">
                                Export Data
                            </button>
                            <button class="admin-btn" style="background: #fd7e14; color: white;" onclick="syncToFirebase()">
                                Force Firebase Sync
                            </button>
                            <button class="admin-btn" style="background: #28a745; color: white;" onclick="testFirebaseWrite()">
                                Test Firebase Write
                            </button>
                            <button class="admin-btn" style="background: #ffc107; color: #212529;" onclick="testLibbyPoetryWrite()">
                                Test Libby's Poetry
                            </button>
                            <button class="admin-btn" style="background: #17a2b8; color: white;" onclick="testCommunityPoetryWrite()">
                                Test Community Poetry
                            </button>
                            <button class="admin-btn" style="background: #e83e8c; color: white;" onclick="checkFirebaseCollections()">
                                Check Collections
                            </button>
                            <button class="admin-btn" style="background: #fd7e14; color: white;" onclick="forceCreatePoetryCollection()">
                                Force Create Poetry Collection
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Libby's Poetry Tab -->
                <div id="admin-tab-libby-poetry" class="admin-tab-content">
                    <div class="admin-form-section">
                        <h4> Add New Poetry Entry</h4>
                        <form id="admin-poetry-form">
                            <div class="form-group">
                                <label for="admin-poem-title">Poem Title:</label>
                                <input type="text" id="admin-poem-title" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-poem-content">Poem Content:</label>
                                <textarea id="admin-poem-content" required style="height: 120px;"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="admin-poem-author">Author:</label>
                                <input type="text" id="admin-poem-author" value="Libby Nessworthy" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-poem-image">Upload Image (optional):</label>
                                <input type="file" id="admin-poem-image" accept="image/*">
                                <div id="admin-poem-image-preview" class="image-preview"></div>
                            </div>
                            <button type="submit" class="submit-btn">
                                Add Poetry Entry
                                <div class="submit-btn-leaf"></div>
                            </button>
                        </form>
                    </div>
                    
                    <h4> Existing Poetry Entries</h4>
                    <div id="admin-libby-poetry-list" class="admin-items-grid">
                        <!-- Libby's poetry entries -->
                    </div>
                </div>

                <!-- Community Poetry Tab -->
                <div id="admin-tab-community-poetry" class="admin-tab-content">
                    <h4>Community Poetry Submissions</h4>
                    <div id="admin-community-poetry-list" class="admin-items-grid">
                        <!-- Community poetry entries -->
                    </div>
                </div>

                <!-- Shop Items Tab -->
                <div id="admin-tab-shop-items" class="admin-tab-content">
                    <div class="admin-form-section">
                        <h4> Add New Shop Item</h4>
                        <form id="shop-item-form">
                            <div class="form-group">
                                <label for="item-name">Item Name:</label>
                                <input type="text" id="item-name">
                            </div>
                            <div class="form-group">
                                <label for="item-description">Description:</label>
                                <textarea id="item-description"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="item-price">Price:</label>
                                <input type="text" id="item-price" placeholder="$24.99">
                            </div>
                            <div class="form-group">
                                <label for="item-image-file">Upload Image:</label>
                                <input type="file" id="item-image-file" accept="image/*">
                                <div id="item-image-preview" class="image-preview"></div>
                                <label for="item-image">Or Image URL:</label>
                                <input type="url" id="item-image">
                            </div>
                            <div class="form-group">
                                <label for="item-link">Link (optional):</label>
                                <input type="url" id="item-link">
                            </div>
                            <button type="submit" class="submit-btn">
                                Add Shop Item
                                <div class="submit-btn-leaf"></div>
                            </button>
                        </form>
                    </div>
                    
                    <h4> Current Shop Items</h4>
                    <div id="admin-shop-list" class="admin-items-grid">
                        <!-- Shop items -->
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="admin-tab-settings" class="admin-tab-content">
                    <div class="admin-form-section">
                        <h4> Manage Announcement</h4>
                        <div class="form-group">
                            <label for="announcement-text">Announcement Text:</label>
                            <input type="text" id="announcement-text">
                        </div>
                        <button class="submit-btn" onclick="updateAnnouncement()">
                            Update Announcement
                            <div class="submit-btn-leaf"></div>
                        </button>
                    </div>

                    <div class="admin-form-section">
                        <h4> Manage Introduction Text</h4>
                        <div class="form-group">
                            <label for="intro-text-admin">Introduction Text:</label>
                            <textarea id="intro-text-admin" style="height: 200px;"></textarea>
                        </div>
                        <button class="submit-btn" onclick="updateIntroText()">
                            Update Introduction
                            <div class="submit-btn-leaf"></div>
                        </button>
                    </div>
                </div>

                <!-- Logout Section -->
                <div class="logout-section">
                    <button class="submit-btn" onclick="logout()" style="background: #dc3545;">
                         Logout from Admin Panel
                        <div class="submit-btn-leaf"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ENHANCED FIREBASE + LOCALSTORAGE SYSTEM ====================
        
        /**
         * Enhanced DataStore with Firebase Integration + LocalStorage Fallback
         * Provides true multi-storage capability with reliability
         */
        class EnhancedDataStore {
            constructor() {
                this.storageKey = 'libby_poetry_datastore';
                this.version = '2.1';
                this.isOnline = navigator.onLine;
                this.firebaseEnabled = false;
                this.firebaseDb = null;
                this.firebaseModules = null;
                this.syncQueue = [];
                this.retryCount = 0;
                this.maxRetries = 3;
                
                console.log(' Enhanced DataStore initializing...');
                
                // Initialize local data first
                this.data = this.loadFromLocalStorage();
                
                // Initialize Firebase asynchronously
                this.initializeFirebase().then(() => {
                    this.updateStatus('Firebase Ready', false);
                    console.log(' Firebase initialization completed successfully!');
                }).catch(error => {
                    console.warn(' Firebase initialization failed - Details:', error.message);
                    if (error.message.includes('timeout')) {
                        console.warn(' Suggestion: Check internet connection and try refreshing the page');
                    } else if (error.message.includes('import')) {
                        console.warn(' Suggestion: Firebase CDN might be blocked or unavailable');
                    } else {
                        console.warn(' Suggestion: Check Firebase project configuration and console for details');
                    }
                    this.updateStatus('Local Storage Only', false);
                });
                
                // Setup event listeners
                this.setupEventListeners();
            }
            
            async initializeFirebase() {
                try {
                    this.updateStatus('Connecting to Firebase...', false);
                    
                    // Firebase configuration
                    const firebaseConfig = {
                        apiKey: "AIzaSyA5GJ9-rA-P2BXL4paZ9YKs_baFPQcpwIc",
                        authDomain: "poeticlens-585ae.firebaseapp.com", 
                        projectId: "poeticlens-585ae",
                        storageBucket: "poeticlens-585ae.firebasestorage.app",
                        messagingSenderId: "214230848269",
                        appId: "1:214230848269:web:61cdfdc7c1a7d89da29644"
                    };
                    
                    // Import Firebase modules with timeout using latest version
                    console.log(' Importing Firebase modules...');
                    const importPromise = Promise.all([
                        import('https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js'),
                        import('https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js')
                    ]);
                    
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Firebase import timeout after 15 seconds')), 15000)
                    );
                    
                    const [appModule, firestoreModule] = await Promise.race([importPromise, timeoutPromise]);
                    console.log(' Firebase modules imported successfully');
                    
                    // Initialize Firebase
                    const app = appModule.initializeApp(firebaseConfig);
                    this.firebaseDb = firestoreModule.getFirestore(app);
                    this.firebaseModules = {
                        collection: firestoreModule.collection,
                        doc: firestoreModule.doc,
                        setDoc: firestoreModule.setDoc,
                        getDoc: firestoreModule.getDoc,
                        getDocs: firestoreModule.getDocs,
                        deleteDoc: firestoreModule.deleteDoc,
                        onSnapshot: firestoreModule.onSnapshot,
                        serverTimestamp: firestoreModule.serverTimestamp,
                        addDoc: firestoreModule.addDoc
                    };
                    
                    this.firebaseEnabled = true;
                    console.log(' Firebase initialized successfully');
                    console.log(' Firebase DB instance:', this.firebaseDb);
                    
                    // Test Firebase connection
                    await this.testFirebaseConnection();
                    
                    // Load data from Firebase and sync
                    await this.loadFromFirebase();
                    await this.syncPendingChanges();
                    
                    return true;
                } catch (error) {
                    console.error(' Firebase initialization failed:', error);
                    console.error('Error details:', error.message);
                    this.firebaseEnabled = false;
                    throw error;
                }
            }
            
            async testFirebaseConnection() {
                try {
                    console.log(' Testing Firebase connection...');
                    const { collection, getDocs } = this.firebaseModules;
                    
                    // Try to access a collection (this will create it if it doesn't exist)
                    const testCollection = collection(this.firebaseDb, 'connectionTest');
                    const testSnapshot = await getDocs(testCollection);
                    
                    console.log(' Firebase connection test successful');
                    return true;
                } catch (error) {
                    console.error(' Firebase connection test failed:', error);
                    throw error;
                }
            }
            
            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateStatus('Back Online', false);
                    if (this.firebaseEnabled) {
                        this.syncPendingChanges();
                    }
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateStatus('Offline Mode', true);
                });
                
                // Auto-save to localStorage every 30 seconds
                setInterval(() => {
                    this.saveToLocalStorage();
                }, 30000);
            }
            
            loadFromLocalStorage() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const data = JSON.parse(stored);
                        console.log(' Data loaded from localStorage');
                        return data;
                    }
                } catch (error) {
                    console.error(' Error loading from localStorage:', error);
                }
                
                return this.getDefaultData();
            }
            
            saveToLocalStorage() {
                try {
                    this.data.lastModified = Date.now();
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    return true;
                } catch (error) {
                    console.error(' Error saving to localStorage:', error);
                    this.updateStatus('Local Save Error', true);
                    return false;
                }
            }
            
            async loadFromFirebase() {
                if (!this.firebaseEnabled) return false;
                
                try {
                    console.log(' Loading data from Firebase...');
                    const { collection, getDocs } = this.firebaseModules;
                    
                    // Load collections
                    const collections = ['poetryEntries', 'userSubmissions', 'shopItems'];
                    let hasFirebaseData = false;
                    
                    for (const collectionName of collections) {
                        try {
                            const querySnapshot = await getDocs(collection(this.firebaseDb, collectionName));
                            const items = [];
                            
                            querySnapshot.forEach((doc) => {
                                items.push({ id: doc.id, ...doc.data() });
                            });
                            
                            if (items.length > 0) {
                                this.data[collectionName] = items;
                                hasFirebaseData = true;
                                console.log(` Loaded ${items.length} items from ${collectionName}`);
                            }
                        } catch (error) {
                            console.warn(` Error loading ${collectionName}:`, error);
                        }
                    }
                    
                    // Load settings
                    try {
                        const settingsSnapshot = await getDocs(collection(this.firebaseDb, 'settings'));
                        settingsSnapshot.forEach((doc) => {
                            this.data.settings[doc.id] = doc.data().value;
                            hasFirebaseData = true;
                        });
                    } catch (error) {
                        console.warn(' Error loading settings:', error);
                    }
                    
                    if (hasFirebaseData) {
                        this.saveToLocalStorage();
                        console.log(' Firebase data loaded and saved locally');
                    }
                    
                    return hasFirebaseData;
                } catch (error) {
                    console.error(' Error loading from Firebase:', error);
                    return false;
                }
            }
            
            async saveToFirebase(collection, item) {
                if (!this.firebaseEnabled || !this.isOnline) {
                    console.log(` Queueing ${collection}/${item.id} for later sync (Firebase: ${this.firebaseEnabled}, Online: ${this.isOnline})`);
                    this.syncQueue.push({ collection, item, action: 'save' });
                    return false;
                }
                
                try {
                    console.log(` Saving to Firebase: ${collection}/${item.id}`);
                    
                    // Prepare data for Firestore (handle large images, etc.)
                    const preparedData = await prepareDataForFirestore(item);
                    console.log(` Data prepared for Firestore. Image included: ${!!preparedData.image}`);
                    
                    const { doc, setDoc, serverTimestamp } = this.firebaseModules;
                    
                    const firebaseData = {
                        ...preparedData,
                        lastModified: Date.now(),
                        firebaseTimestamp: serverTimestamp()
                    };
                    
                    // Log data size for debugging
                    const dataString = JSON.stringify(firebaseData);
                    const dataSizeKB = (new Blob([dataString]).size) / 1024;
                    console.log(` Total document size: ${dataSizeKB.toFixed(2)} KB`);
                    
                    if (dataSizeKB > 1000) {
                        console.error(` Document too large for Firestore! Size: ${dataSizeKB.toFixed(2)} KB (max: 1MB)`);
                        // Remove image if document is still too large
                        delete firebaseData.image;
                        firebaseData.imageError = 'Image removed due to size constraints';
                        console.log(` Removed image, new size: ${(new Blob([JSON.stringify(firebaseData)]).size / 1024).toFixed(2)} KB`);
                    }
                    
                    console.log(' Target collection:', collection);
                    console.log(' Document ID:', item.id.toString());
                    
                    const docRef = doc(this.firebaseDb, collection, item.id.toString());
                    console.log(' Document reference created:', docRef);
                    console.log(' Document reference path:', docRef.path);
                    
                    // Special logging for poetryEntries collection
                    if (collection === 'poetryEntries') {
                        console.log(' SPECIAL DEBUG - LIBBY\'S POETRY:');
                        console.log('   Collection name exactly:', JSON.stringify(collection));
                        console.log('   Collection length:', collection.length);
                        console.log('   Collection type:', typeof collection);
                        console.log('   Document ID:', JSON.stringify(item.id.toString()));
                        console.log('   Full path will be:', `${collection}/${item.id.toString()}`);
                        console.log('   Has image:', !!firebaseData.image);
                        console.log('   Document size:', dataSizeKB.toFixed(2), 'KB');
                        console.log('   Firebase DB instance:', this.firebaseDb);
                        console.log('   Doc function:', typeof doc);
                        console.log('   SetDoc function:', typeof setDoc);
                    }
                    
                    console.log(' Calling setDoc with merge option...');
                    await setDoc(docRef, firebaseData, { merge: true });
                    
                    console.log(` Successfully saved to Firebase: ${collection}/${item.id}`);
                    
                    // Verify the document was created for poetryEntries
                    if (collection === 'poetryEntries') {
                        console.log(' Verifying poetryEntries document was created...');
                        try {
                            const { getDoc } = this.firebaseModules;
                            const verifyDoc = await getDoc(docRef);
                            if (verifyDoc.exists()) {
                                console.log(' VERIFIED: Document exists in poetryEntries collection');
                                const docData = verifyDoc.data();
                                console.log(' Document data:', {
                                    title: docData.title,
                                    author: docData.author,
                                    hasImage: !!docData.image,
                                    hasImageError: !!docData.imageError
                                });
                            } else {
                                console.error(' VERIFICATION FAILED: Document does not exist after creation');
                            }
                        } catch (verifyError) {
                            console.error(' Error verifying document:', verifyError);
                        }
                    }
                    
                    return true;
                } catch (error) {
                    console.error(` Error saving to Firebase (${collection}/${item.id}):`, error);
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    console.error('Error code:', error.code);
                    console.error('Error stack:', error.stack);
                    
                    // Special handling for poetryEntries errors
                    if (collection === 'poetryEntries') {
                        console.error(' SPECIAL ERROR ANALYSIS - LIBBY\'S POETRY:');
                        console.error('   This error occurred while trying to save to poetryEntries');
                        console.error('   Check if there are Firebase security rules preventing writes to this collection');
                        console.error('   Check if the collection name has any special restrictions');
                        console.error('   Document might be too large for Firestore (1MB limit)');
                        console.error('   Error details:', {
                            name: error.name,
                            message: error.message,
                            code: error.code,
                            collection: collection,
                            itemId: item.id,
                            hasImage: !!item.image
                        });
                    }
                    
                    // Queue for retry
                    console.log(` Queueing ${collection}/${item.id} for retry`);
                    this.syncQueue.push({ collection, item, action: 'save' });
                    return false;
                }
            }
            
            async deleteFromFirebase(collection, id) {
                if (!this.firebaseEnabled || !this.isOnline) {
                    this.syncQueue.push({ collection, id, action: 'delete' });
                    return false;
                }
                
                try {
                    const { doc, deleteDoc } = this.firebaseModules;
                    const docRef = doc(this.firebaseDb, collection, id.toString());
                    await deleteDoc(docRef);
                    
                    console.log(` Deleted from Firebase: ${collection}/${id}`);
                    return true;
                } catch (error) {
                    console.error(` Error deleting from Firebase:`, error);
                    this.syncQueue.push({ collection, id, action: 'delete' });
                    return false;
                }
            }
            
            async syncPendingChanges() {
                if (!this.firebaseEnabled || !this.isOnline || this.syncQueue.length === 0) {
                    return;
                }
                
                console.log(` Syncing ${this.syncQueue.length} pending changes...`);
                
                const queue = [...this.syncQueue];
                this.syncQueue = [];
                
                for (const change of queue) {
                    try {
                        if (change.action === 'save') {
                            await this.saveToFirebase(change.collection, change.item);
                        } else if (change.action === 'delete') {
                            await this.deleteFromFirebase(change.collection, change.id);
                        }
                    } catch (error) {
                        // Re-queue failed operations
                        this.syncQueue.push(change);
                    }
                }
                
                if (this.syncQueue.length > 0) {
                    console.log(` ${this.syncQueue.length} changes still pending sync`);
                }
            }
            
            // ==================== CRUD OPERATIONS ====================
            
            async create(collection, item) {
                try {
                    const timestamp = Date.now();
                    const newItem = {
                        ...item,
                        id: item.id || timestamp,
                        createdAt: timestamp,
                        modifiedAt: timestamp
                    };
                    
                    // Save locally first (always works)
                    if (!this.data[collection]) {
                        this.data[collection] = [];
                    }
                    this.data[collection].push(newItem);
                    const localSaved = this.saveToLocalStorage();
                    
                    // Try to save to Firebase
                    const firebaseSaved = await this.saveToFirebase(collection, newItem);
                    
                    this.updateStatus(firebaseSaved ? 'Saved to Firebase' : 'Saved Locally', !firebaseSaved);
                    
                    console.log(` Created ${collection} item:`, newItem.id, firebaseSaved ? '(Firebase + Local)' : '(Local only)');
                    return { success: true, data: newItem, synced: firebaseSaved };
                } catch (error) {
                    console.error(` Failed to create ${collection} item:`, error);
                    this.updateStatus('Create Error', true);
                    return { success: false, error: error.message };
                }
            }
            
            read(collection, id = null) {
                try {
                    if (!this.data[collection]) {
                        return { success: true, data: [] };
                    }
                    
                    if (id) {
                        const item = this.data[collection].find(item => item.id === id);
                        return { success: true, data: item || null };
                    }
                    
                    return { success: true, data: [...this.data[collection]] };
                } catch (error) {
                    console.error(` Failed to read ${collection}:`, error);
                    return { success: false, error: error.message };
                }
            }
            
            async update(collection, id, updates) {
                try {
                    if (!this.data[collection]) {
                        return { success: false, error: 'Collection not found' };
                    }
                    
                    const index = this.data[collection].findIndex(item => item.id === id);
                    if (index === -1) {
                        return { success: false, error: 'Item not found' };
                    }
                    
                    const updatedItem = {
                        ...this.data[collection][index],
                        ...updates,
                        modifiedAt: Date.now()
                    };
                    
                    // Update locally first
                    this.data[collection][index] = updatedItem;
                    const localSaved = this.saveToLocalStorage();
                    
                    // Try to save to Firebase
                    const firebaseSaved = await this.saveToFirebase(collection, updatedItem);
                    
                    this.updateStatus(firebaseSaved ? 'Updated in Firebase' : 'Updated Locally', !firebaseSaved);
                    
                    console.log(` Updated ${collection} item:`, id, firebaseSaved ? '(Firebase + Local)' : '(Local only)');
                    return { success: true, data: updatedItem, synced: firebaseSaved };
                } catch (error) {
                    console.error(` Failed to update ${collection} item:`, error);
                    this.updateStatus('Update Error', true);
                    return { success: false, error: error.message };
                }
            }
            
            async delete(collection, id) {
                try {
                    if (!this.data[collection]) {
                        return { success: false, error: 'Collection not found' };
                    }
                    
                    const index = this.data[collection].findIndex(item => item.id === id);
                    if (index === -1) {
                        return { success: false, error: 'Item not found' };
                    }
                    
                    // Remove locally first
                    const deletedItem = this.data[collection].splice(index, 1)[0];
                    const localSaved = this.saveToLocalStorage();
                    
                    // Try to delete from Firebase
                    const firebaseDeleted = await this.deleteFromFirebase(collection, id);
                    
                    this.updateStatus(firebaseDeleted ? 'Deleted from Firebase' : 'Deleted Locally', !firebaseDeleted);
                    
                    console.log(` Deleted ${collection} item:`, id, firebaseDeleted ? '(Firebase + Local)' : '(Local only)');
                    return { success: true, data: deletedItem, synced: firebaseDeleted };
                } catch (error) {
                    console.error(` Failed to delete ${collection} item:`, error);
                    this.updateStatus('Delete Error', true);
                    return { success: false, error: error.message };
                }
            }
            
            // ==================== SETTINGS OPERATIONS ====================
            
            getSetting(key) {
                return this.data.settings[key] || null;
            }
            
            async setSetting(key, value) {
                try {
                    // Update locally first
                    this.data.settings[key] = value;
                    this.data.lastModified = Date.now();
                    const localSaved = this.saveToLocalStorage();
                    
                    // Try to save to Firebase
                    let firebaseSaved = false;
                    if (this.firebaseEnabled && this.isOnline) {
                        try {
                            const { doc, setDoc, serverTimestamp } = this.firebaseModules;
                            const settingData = {
                                value: value,
                                lastModified: Date.now(),
                                firebaseTimestamp: serverTimestamp()
                            };
                            const docRef = doc(this.firebaseDb, 'settings', key);
                            await setDoc(docRef, settingData);
                            firebaseSaved = true;
                        } catch (error) {
                            console.warn(` Failed to save setting to Firebase:`, error);
                        }
                    }
                    
                    this.updateStatus(firebaseSaved ? 'Setting Saved to Firebase' : 'Setting Saved Locally', !firebaseSaved);
                    
                    console.log(` Updated setting: ${key}`, firebaseSaved ? '(Firebase + Local)' : '(Local only)');
                    return { success: true, synced: firebaseSaved };
                } catch (error) {
                    console.error(` Failed to update setting: ${key}`, error);
                    return { success: false, error: error.message };
                }
            }
            
            // ==================== UTILITY FUNCTIONS ====================
            
            getDefaultData() {
                return {
                    version: this.version,
                    lastModified: Date.now(),
                    poetryEntries: [
                        {
                            id: 1,
                            title: "Wild Child",
                            content: "The summer leaves whisper to me,\nCome out and play again, wild child,\nThe trees miss your untethered heart.\nThe summer birds sing to me,\nCome dance beneath us, wild child,\nUse our wings to lift your mind.\nThe summer beat of my footsteps on soil calls to me,\nLet go with each step, wild child,\nYour wildness makes you beautiful.\nThe summer sun on delicate, intricate petals feeds my soul,\nFeel it soak into your face, wild child,\nBe reborn, be home, be whole.\nShe still lingers within.",
                            author: "Libby Nessworthy",
                            image: "https://scontent-man2-1.xx.fbcdn.net/v/t39.30808-6/501631554_122156928800568294_5438287569295846653_n.jpg?stp=cp6_dst-jpg_s720x720_tt6&_nc_cat=105&ccb=1-7&_nc_sid=833d8c&_nc_ohc=RQB3upzL-WoQ7kNvwFawezN&_nc_oc=Adnu1kKFnOvThcD1sD_m3HAF2Rilwcz1kohYd-frGhrqDGSbyawRp2laxUm3txInL9Tki5ouQofWzmhwoFu3AZLp&_nc_zt=23&_nc_ht=scontent-man2-1.xx&_nc_gid=HmXyqXlHFRm8j_Lb6iS3XA&oh=00_AfI7WSzScSOglpImkWzNg6bCwWUiFVJ8aNN26TgpBhSrDA&oe=684264E6",
                            createdAt: Date.now(),
                            modifiedAt: Date.now()
                        },
                        {
                            id: 2,
                            title: "Flowering",
                            content: "Secret forest warmth,\nbeautiful, quiet breath,\nbeneath cycles of the moon,\nnature lighting my way,\npoetry pulsing through my fingertips,\nI am flowering here.",
                            author: "Libby Nessworthy",
                            image: "https://scontent-man2-1.xx.fbcdn.net/v/t39.30808-6/492123195_122150141522568294_1437317788203308205_n.jpg?stp=cp6_dst-jpg_s720x720_tt6&_nc_cat=104&ccb=1-7&_nc_sid=833d8c&_nc_ohc=g3c7k4gw534Q7kNvwHAXKgD&_nc_oc=Adn1hBjrbu_vAS5NOvxEd8-ePWeKShtkqle00mRo2Ep1zoWd-UeUQOK5KMCopD1B-htYTxQpC9lQAIL5-ymNJ1i_&_nc_zt=23&_nc_ht=scontent-man2-1.xx&_nc_gid=eIifBj0VfPFACNzIVQqSLQ&oh=00_AfJx8syap8I5ocvJ1N4b3a9tRyCqOWKvaghiWvAf6jtPKg&oe=684268E6",
                            createdAt: Date.now(),
                            modifiedAt: Date.now()
                        }
                    ],
                    userSubmissions: [],
                    shopItems: [
                        {
                            id: 1,
                            name: "Poetry Collection - 'Nature's Love'",
                            description: "A beautiful hardcover collection of Libby's most beloved nature and love poems.",
                            price: "$24.99",
                            image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='200' viewBox='0 0 300 200'%3E%3Crect fill='%238B4513' width='300' height='200'/%3E%3Ctext x='50%' y='50%' text-anchor='middle' fill='gold' font-size='16' font-family='serif'%3EPoetry Book%3C/text%3E%3C/svg%3E",
                            link: "",
                            createdAt: Date.now(),
                            modifiedAt: Date.now()
                        }
                    ],
                    settings: {
                        announcement: "Welcome to Poetic Lens - Where Nature Meets Words ",
                        introText: "Welcome to my poetic sanctuary where the whispers of nature dance with the melodies of love. I am Libby Nessworthy, a passionate poet who finds inspiration in the rustling leaves, blooming flowers, and the eternal dance between earth and heart.\n\nMy journey began in the quiet moments of dawn, when dewdrops held the secrets of the universe, and in the gentle embrace of twilight, where love stories are written in starlight. Each poem is a bridge between the natural world and the depths of human emotion.\n\nHere, you'll discover verses that celebrate the changing seasons of both nature and the heart, exploring how love grows like wildflowers and how our souls mirror the rhythms of the earth. Join me in this garden of words where every stanza blooms with authenticity and wonder."
                    },
                    cooldownUsers: {}
                };
            }
            
            updateStatus(message, isError = false) {
                const statusElement = document.getElementById('datastore-status');
                const statusTextElement = document.getElementById('datastore-status-text');
                const firebaseStatusElement = document.getElementById('firebase-status');
                
                console.log(` Status update: ${message} (Error: ${isError})`);
                
                if (statusElement) {
                    statusElement.textContent = ` ${message}`;
                    statusElement.className = `datastore-status ${isError ? 'error' : ''}`;
                }
                
                if (statusTextElement) {
                    statusTextElement.textContent = message;
                    statusTextElement.style.color = isError ? '#dc3545' : '#28a745';
                }
                
                if (firebaseStatusElement) {
                    if (this.firebaseEnabled) {
                        firebaseStatusElement.textContent = 'Connected ';
                        firebaseStatusElement.style.color = '#28a745';
                    } else {
                        firebaseStatusElement.textContent = 'Unavailable ';
                        firebaseStatusElement.style.color = '#dc3545';
                    }
                }
                
                // Reset status after 5 seconds for temporary messages
                if (message !== 'Ready' && !message.includes('Firebase Ready') && !message.includes('Local Storage Only')) {
                    setTimeout(() => {
                        if (this.firebaseEnabled) {
                            this.updateStatus('Firebase Ready', false);
                        } else {
                            this.updateStatus('Local Storage Only', false);
                        }
                    }, 5000);
                }
            }
            
            // ==================== ADMIN UTILITY FUNCTIONS ====================
            
            checkCooldown(user) {
                const cooldownTime = this.data.cooldownUsers[user];
                if (cooldownTime && Date.now() < cooldownTime) {
                    return Math.ceil((cooldownTime - Date.now()) / 1000 / 60);
                }
                return 0;
            }
            
            setCooldown(user, minutes = 5) {
                this.data.cooldownUsers[user] = Date.now() + (minutes * 60 * 1000);
                this.saveToLocalStorage();
            }
            
            getStats() {
                return {
                    poetryEntries: this.data.poetryEntries?.length || 0,
                    userSubmissions: this.data.userSubmissions?.length || 0,
                    shopItems: this.data.shopItems?.length || 0,
                    settings: Object.keys(this.data.settings).length,
                    totalContent: (this.data.poetryEntries?.length || 0) + (this.data.userSubmissions?.length || 0),
                    lastModified: this.data.lastModified,
                    version: this.version,
                    firebaseEnabled: this.firebaseEnabled,
                    isOnline: this.isOnline,
                    pendingSync: this.syncQueue.length
                };
            }
            
            exportData() {
                return {
                    ...this.data,
                    exportDate: new Date().toISOString(),
                    stats: this.getStats()
                };
            }
        }

        // Initialize enhanced datastore
        const datastore = new EnhancedDataStore();

        // ==================== LEGACY COMPATIBILITY LAYER ====================
        
        // Admin credentials
        const ADMIN_USERNAME = 'Nessworthy';
        const ADMIN_PASSWORD = 'Nature';
        let isLoggedIn = false;

        // ==================== UI FUNCTIONS ====================

        function showPage(pageId) {
            console.log('Showing page:', pageId);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Handle specific page logic
            if (pageId === 'book') {
                populateBook();
                populateLibbyPoetryGrid();
            } else if (pageId === 'user-book') {
                populateUserBook();
                populatePoetryGrid();
            } else if (pageId === 'shop') {
                populateShop();
            } else if (pageId === 'admin-panel') {
                if (isLoggedIn) {
                    populateAdminPanel();
                } else {
                    showPage('admin-login');
                    return;
                }
            } else if (pageId === 'submit') {
                checkCooldownDisplay();
            }
        }

        function toggleBook(bookId) {
            const book = document.getElementById(bookId);
            book.classList.toggle('open');
        }

        function populateBook() {
            const bookContent = document.getElementById('book-content');
            const result = datastore.read('poetryEntries');
            
            if (result.success) {
                bookContent.innerHTML = result.data.map(entry => `
                    <div class="poetry-entry" id="libby-poem-${entry.id}">
                        <div class="poetry-title">${entry.title}</div>
                        ${entry.image ? `<img src="${entry.image}" alt="${entry.title}" class="poetry-image" onerror="this.style.display='none'">` : ''}
                        <div class="poetry-content">${entry.content}</div>
                        <div class="poetry-author">~ ${entry.author}</div>
                    </div>
                `).join('');
            }
        }

        function populateLibbyPoetryGrid() {
            const poetryGrid = document.getElementById('libby-poetry-grid');
            const result = datastore.read('poetryEntries');
            
            if (result.success) {
                const entries = result.data;
                if (entries.length === 0) {
                    poetryGrid.innerHTML = `
                        <div class="poetry-card">
                            <div class="poetry-card-header">
                                <div>
                                    <h3 class="poetry-card-title">No Poetry Yet</h3>
                                    <div class="poetry-card-author">Libby Nessworthy Collection</div>
                                </div>
                            </div>
                            <div class="poetry-card-content">
                                Welcome to Libby's poetry collection. New poems will appear here as they are added to the archive.
                            </div>
                            <div class="poetry-card-date">Awaiting new poetry...</div>
                        </div>
                    `;
                } else {
                    poetryGrid.innerHTML = entries.map(entry => `
                        <div class="poetry-card" onclick="viewLibbyPoetryInBook(${entry.id})">
                            <div class="poetry-card-header">
                                <div>
                                    <h3 class="poetry-card-title">${entry.title}</h3>
                                    <div class="poetry-card-author">by ${entry.author}</div>
                                </div>
                                ${entry.image ? `<img src="${entry.image}" alt="${entry.title}" class="poetry-card-image" onerror="this.style.display='none'">` : ''}
                            </div>
                            <div class="poetry-card-content">${entry.content.substring(0, 200)}${entry.content.length > 200 ? '...' : ''}</div>
                            <div class="poetry-card-date">${entry.createdAt ? new Date(entry.createdAt).toLocaleDateString() : 'Classic collection'}</div>
                        </div>
                    `).join('');
                }
            }
        }

        function populateUserBook() {
            const userBookContent = document.getElementById('user-book-content');
            const result = datastore.read('userSubmissions');
            
            if (result.success) {
                const submissions = result.data;
                if (submissions.length === 0) {
                    userBookContent.innerHTML = `
                        <div class="poetry-entry">
                            <div class="poetry-title">Welcome to Community Poetry</div>
                            <div class="poetry-content">This beautiful collection will grow as poets like you share their voices. Be the first to add your poem to this community anthology!</div>
                            <div class="poetry-author">~ The Poetry Garden</div>
                        </div>
                    `;
                } else {
                    userBookContent.innerHTML = submissions.map(entry => `
                        <div class="poetry-entry" id="poem-${entry.id}">
                            <div class="poetry-title">${entry.title}</div>
                            ${entry.image ? `<img src="${entry.image}" alt="${entry.title}" class="poetry-image" onerror="this.style.display='none'">` : ''}
                            <div class="poetry-content">${entry.content}</div>
                            <div class="poetry-author">~ ${entry.author}</div>
                        </div>
                    `).join('');
                }
            }
        }

        function populatePoetryGrid() {
            const poetryGrid = document.getElementById('poetry-grid');
            const result = datastore.read('userSubmissions');
            
            if (result.success) {
                const submissions = result.data;
                if (submissions.length === 0) {
                    poetryGrid.innerHTML = `
                        <div class="poetry-card">
                            <div class="poetry-card-header">
                                <div>
                                    <h3 class="poetry-card-title">No Community Poems Yet</h3>
                                    <div class="poetry-card-author">Community Collection</div>
                                </div>
                            </div>
                            <div class="poetry-card-content">
                                Be the first to share your poetry with our community! Use the "Add New Poetry" button above to contribute your voice to this growing collection.
                            </div>
                            <div class="poetry-card-date">Awaiting your contribution...</div>
                        </div>
                    `;
                } else {
                    poetryGrid.innerHTML = submissions.map(entry => `
                        <div class="poetry-card" onclick="viewPoetryInBook(${entry.id})">
                            <div class="poetry-card-header">
                                <div>
                                    <h3 class="poetry-card-title">${entry.title}</h3>
                                    <div class="poetry-card-author">by ${entry.author}</div>
                                </div>
                                ${entry.image ? `<img src="${entry.image}" alt="${entry.title}" class="poetry-card-image" onerror="this.style.display='none'">` : ''}
                            </div>
                            <div class="poetry-card-content">${entry.content.substring(0, 200)}${entry.content.length > 200 ? '...' : ''}</div>
                            <div class="poetry-card-date">${entry.createdAt ? new Date(entry.createdAt).toLocaleDateString() : 'Recently added'}</div>
                        </div>
                    `).join('');
                }
            }
        }

        function populateShop() {
            const shopContainer = document.getElementById('shop-items');
            const result = datastore.read('shopItems');
            
            if (result.success) {
                shopContainer.innerHTML = result.data.map(item => `
                    <div class="shop-item">
                        <img src="${item.image}" alt="${item.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'300\\' height=\\'200\\' viewBox=\\'0 0 300 200\\'%3E%3Crect fill=\\'%23f0f0f0\\' width=\\'300\\' height=\\'200\\'/%3E%3Ctext x=\\'50%\\' y=\\'50%\\' text-anchor=\\'middle\\' fill=\\'%23666\\' font-size=\\'14\\'%3ENo Image%3C/text%3E%3C/svg%3E'">
                        <h3>${item.name}</h3>
                        <p>${item.description}</p>
                        <div class="price">${item.price}</div>
                        ${item.link ? `<a href="${item.link}" target="_blank" style="color: #0891b2; text-decoration: none;">View Item </a>` : ''}
                    </div>
                `).join('');
            }
        }

        function togglePoetryCreationForm() {
            const form = document.getElementById('poetry-creation-form');
            const isVisible = form.classList.contains('active');
            
            if (isVisible) {
                form.classList.remove('active');
                document.getElementById('community-poetry-form').reset();
                document.getElementById('community-poem-image-preview').innerHTML = '';
            } else {
                form.classList.add('active');
            }
        }

        function viewPoetryInBook(poetryId) {
            const book = document.getElementById('user-poetry-book');
            if (!book.classList.contains('open')) {
                book.classList.add('open');
            }
            
            setTimeout(() => {
                const poemElement = document.getElementById(`poem-${poetryId}`);
                if (poemElement) {
                    poemElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    poemElement.style.background = 'rgba(125, 211, 252, 0.3)';
                    setTimeout(() => {
                        poemElement.style.background = 'rgba(125, 211, 252, 0.1)';
                    }, 2000);
                }
            }, 800);
        }

        function viewLibbyPoetryInBook(poetryId) {
            const book = document.getElementById('poetry-book');
            if (!book.classList.contains('open')) {
                book.classList.add('open');
            }
            
            setTimeout(() => {
                const poemElement = document.getElementById(`libby-poem-${poetryId}`);
                if (poemElement) {
                    poemElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    poemElement.style.background = 'rgba(125, 211, 252, 0.3)';
                    setTimeout(() => {
                        poemElement.style.background = 'rgba(125, 211, 252, 0.1)';
                    }, 2000);
                }
            }, 800);
        }

        function showNotification(title, content, poetryId = null) {
            const notification = document.getElementById('notification');
            const titleElement = document.getElementById('notification-title-text');
            const contentElement = document.getElementById('notification-content');
            
            titleElement.textContent = title;
            contentElement.textContent = content;
            
            notification.classList.add('show');
            
            notification.onclick = () => {
                hideNotification();
                if (poetryId) {
                    showPage('user-book');
                    setTimeout(() => viewPoetryInBook(poetryId), 500);
                }
            };
            
            setTimeout(hideNotification, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function convertImageToBase64(file, maxSizeKB = 800) {
            return new Promise((resolve, reject) => {
                // Check file size first
                const fileSizeKB = file.size / 1024;
                console.log(` Image file size: ${fileSizeKB.toFixed(2)} KB`);
                
                if (fileSizeKB > maxSizeKB) {
                    console.log(` Image too large (${fileSizeKB.toFixed(2)} KB > ${maxSizeKB} KB), will compress...`);
                }
                
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result;
                    const resultSizeKB = (result.length * 0.75) / 1024; // Approximate base64 size
                    console.log(` Base64 size: ${resultSizeKB.toFixed(2)} KB`);
                    
                    if (resultSizeKB > maxSizeKB) {
                        console.log(` Compressing image from ${resultSizeKB.toFixed(2)} KB to under ${maxSizeKB} KB...`);
                        compressImage(result, maxSizeKB).then(resolve).catch(reject);
                    } else {
                        console.log(` Image size acceptable: ${resultSizeKB.toFixed(2)} KB`);
                        resolve(result);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function compressImage(base64String, maxSizeKB = 800) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate new dimensions to reduce file size
                    let { width, height } = img;
                    const maxDimension = 1200; // Max width or height
                    
                    if (width > height && width > maxDimension) {
                        height = (height * maxDimension) / width;
                        width = maxDimension;
                    } else if (height > maxDimension) {
                        width = (width * maxDimension) / height;
                        height = maxDimension;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Try different quality levels until we get under the size limit
                    let quality = 0.8;
                    let compressedBase64;
                    let attempts = 0;
                    const maxAttempts = 5;
                    
                    const tryCompress = () => {
                        compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        const compressedSizeKB = (compressedBase64.length * 0.75) / 1024;
                        
                        console.log(` Compression attempt ${attempts + 1}: ${compressedSizeKB.toFixed(2)} KB at quality ${quality}`);
                        
                        if (compressedSizeKB <= maxSizeKB || attempts >= maxAttempts || quality <= 0.1) {
                            console.log(` Image compressed to ${compressedSizeKB.toFixed(2)} KB`);
                            resolve(compressedBase64);
                        } else {
                            quality -= 0.15;
                            attempts++;
                            tryCompress();
                        }
                    };
                    
                    tryCompress();
                };
                img.onerror = reject;
                img.src = base64String;
            });
        }
        
        async function prepareDataForFirestore(data) {
            const prepared = { ...data };
            
            // Check if image exists and is large
            if (prepared.image) {
                const imageSizeKB = (prepared.image.length * 0.75) / 1024;
                console.log(` Checking image size: ${imageSizeKB.toFixed(2)} KB`);
                
                // If image is too large for Firestore (approaching 1MB limit)
                if (imageSizeKB > 800) {
                    console.log(` Image too large for Firestore (${imageSizeKB.toFixed(2)} KB), compressing...`);
                    try {
                        prepared.image = await compressImage(prepared.image, 700);
                        const newSizeKB = (prepared.image.length * 0.75) / 1024;
                        console.log(` Image compressed to ${newSizeKB.toFixed(2)} KB`);
                    } catch (error) {
                        console.error(' Image compression failed:', error);
                        // Remove image if compression fails
                        delete prepared.image;
                        prepared.imageError = 'Image too large and compression failed';
                    }
                }
            }
            
            // Ensure all required fields are present and valid
            if (!prepared.id) {
                prepared.id = Date.now();
            }
            
            if (!prepared.createdAt) {
                prepared.createdAt = Date.now();
            }
            
            if (!prepared.modifiedAt) {
                prepared.modifiedAt = Date.now();
            }
            
            return prepared;
        }

        function handleImagePreview(event, previewId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-image-btn" onclick="removeImagePreview('${previewId}', '${event.target.id}')">Remove</button>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        }

        function removeImagePreview(previewId, inputId) {
            document.getElementById(previewId).innerHTML = '';
            document.getElementById(inputId).value = '';
        }

        // ==================== ADMIN FUNCTIONS ====================

        function switchAdminTab(tabName, element) {
            try {
                // Hide all tab contents
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                document.getElementById(`admin-tab-${tabName}`).classList.add('active');
                if (element) element.classList.add('active');
                
                // Populate content based on tab
                if (tabName === 'overview') {
                    updateAdminStats();
                } else if (tabName === 'libby-poetry') {
                    populateLibbyPoetryTab();
                } else if (tabName === 'community-poetry') {
                    populateCommunityPoetryTab();
                } else if (tabName === 'shop-items') {
                    populateShopItemsTab();
                } else if (tabName === 'settings') {
                    populateSettingsTab();
                }
            } catch (error) {
                console.error('Error switching admin tab:', error);
            }
        }

        function updateAdminStats() {
            const stats = datastore.getStats();
            document.getElementById('stat-libby-poems').textContent = stats.poetryEntries;
            document.getElementById('stat-community-poems').textContent = stats.userSubmissions;
            document.getElementById('stat-shop-items').textContent = stats.shopItems;
            document.getElementById('stat-total-content').textContent = stats.totalContent;
            
            // Update datastore counts
            document.getElementById('datastore-libby-count').textContent = stats.poetryEntries;
            document.getElementById('datastore-community-count').textContent = stats.userSubmissions;
            document.getElementById('datastore-shop-count').textContent = stats.shopItems;
            document.getElementById('datastore-settings-count').textContent = stats.settings;
            
            // Update network status
            document.getElementById('network-status').textContent = navigator.onLine ? 'Online' : 'Offline';
            document.getElementById('network-status').style.color = navigator.onLine ? '#28a745' : '#dc3545';
        }

        function populateLibbyPoetryTab() {
            const container = document.getElementById('admin-libby-poetry-list');
            const result = datastore.read('poetryEntries');
            
            if (result.success) {
                const entries = result.data;
                if (entries.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No poetry entries yet. Add your first poem above!</p>';
                    return;
                }
                
                container.innerHTML = entries.map(entry => `
                    <div class="admin-item-card">
                        <div class="admin-item-header">
                            <div>
                                <h5 class="admin-item-title">${entry.title}</h5>
                                <div class="admin-item-author">by ${entry.author}</div>
                            </div>
                            ${entry.image ? `<img src="${entry.image}" alt="${entry.title}" class="admin-item-image">` : ''}
                        </div>
                        <div class="admin-item-content">${entry.content.substring(0, 150)}${entry.content.length > 150 ? '...' : ''}</div>
                        <div class="admin-buttons">
                            <button class="admin-btn delete" onclick="deletePoetry(${entry.id}, true)"> Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateCommunityPoetryTab() {
            const container = document.getElementById('admin-community-poetry-list');
            const result = datastore.read('userSubmissions');
            
            if (result.success) {
                const submissions = result.data;
                if (submissions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No community submissions yet. Encourage users to share their poetry!</p>';
                    return;
                }
                
                container.innerHTML = submissions.map(entry => `
                    <div class="admin-item-card">
                        <div class="admin-item-header">
                            <div>
                                <h5 class="admin-item-title">${entry.title}</h5>
                                <div class="admin-item-author">by ${entry.author} (Community)</div>
                            </div>
                            ${entry.image ? `<img src="${entry.image}" alt="${entry.title}" class="admin-item-image">` : ''}
                        </div>
                        <div class="admin-item-content">${entry.content.substring(0, 150)}${entry.content.length > 150 ? '...' : ''}</div>
                        <div class="admin-buttons">
                            <button class="admin-btn delete" onclick="deletePoetry(${entry.id}, false)"> Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateShopItemsTab() {
            const container = document.getElementById('admin-shop-list');
            const result = datastore.read('shopItems');
            
            if (result.success) {
                const items = result.data;
                container.innerHTML = items.map(item => `
                    <div class="admin-item-card">
                        <div class="admin-item-header">
                            <div>
                                <h5 class="admin-item-title">${item.name}</h5>
                                <div class="admin-item-author">${item.price}</div>
                            </div>
                            <img src="${item.image}" alt="${item.name}" class="admin-item-image">
                        </div>
                        <div class="admin-item-content">${item.description}</div>
                        ${item.link ? `<p><a href="${item.link}" target="_blank" style="color: #7dd3fc;"> View Item</a></p>` : ''}
                        <div class="admin-buttons">
                            <button class="admin-btn delete" onclick="deleteShopItem(${item.id})"> Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateSettingsTab() {
            const announcementInput = document.getElementById('announcement-text');
            const introTextInput = document.getElementById('intro-text-admin');
            
            if (announcementInput) {
                announcementInput.value = datastore.getSetting('announcement') || '';
            }
            if (introTextInput) {
                introTextInput.value = datastore.getSetting('introText') || '';
            }
        }

        function populateAdminPanel() {
            try {
                updateAdminStats();
                populateLibbyPoetryTab();
                populateCommunityPoetryTab();
                populateShopItemsTab();
                populateSettingsTab();
            } catch (error) {
                console.error('Error populating admin panel:', error);
            }
        }

        async function updateAnnouncement() {
            const newAnnouncement = document.getElementById('announcement-text').value;
            const result = await datastore.setSetting('announcement', newAnnouncement);
            
            if (result.success) {
                document.getElementById('announcement').textContent = newAnnouncement;
                const syncStatus = result.synced ? '(Saved to Firebase)' : '(Saved locally - will sync when online)';
                alert(` Announcement updated successfully! ${syncStatus}`);
            } else {
                alert(' Failed to update announcement: ' + (result.error || 'Unknown error'));
            }
        }

        async function updateIntroText() {
            const newIntroText = document.getElementById('intro-text-admin').value;
            const result = await datastore.setSetting('introText', newIntroText);
            
            if (result.success) {
                document.getElementById('intro-text').textContent = newIntroText;
                const syncStatus = result.synced ? '(Saved to Firebase)' : '(Saved locally - will sync when online)';
                alert(` Introduction text updated successfully! ${syncStatus}`);
            } else {
                alert(' Failed to update introduction text: ' + (result.error || 'Unknown error'));
            }
        }

        async function deletePoetry(id, isAdmin) {
            const collection = isAdmin ? 'poetryEntries' : 'userSubmissions';
            const result = datastore.read(collection, id);
            
            if (!result.success || !result.data) {
                alert(' Poetry entry not found.');
                return;
            }
            
            const entry = result.data;
            if (confirm(` Are you sure you want to delete "${entry.title}"?\n\nThis action cannot be undone.`)) {
                const deleteResult = await datastore.delete(collection, id);
                
                if (deleteResult.success) {
                    // Refresh admin panel and user views
                    populateAdminPanel();
                    if (!isAdmin) {
                        populateUserBook();
                        populatePoetryGrid();
                    } else {
                        populateBook();
                        populateLibbyPoetryGrid();
                    }
                    
                    const syncStatus = deleteResult.synced ? '(Deleted from Firebase)' : '(Deleted locally - will sync when online)';
                    alert(` Poetry entry deleted successfully! ${syncStatus}`);
                } else {
                    alert(' Failed to delete poetry entry: ' + (deleteResult.error || 'Unknown error'));
                }
            }
        }

        async function deleteShopItem(id) {
            const result = datastore.read('shopItems', id);
            
            if (!result.success || !result.data) {
                alert(' Shop item not found.');
                return;
            }
            
            const item = result.data;
            if (confirm(` Are you sure you want to delete "${item.name}"?\n\nThis action cannot be undone.`)) {
                const deleteResult = await datastore.delete('shopItems', id);
                
                if (deleteResult.success) {
                    populateShopItemsTab();
                    populateShop();
                    updateAdminStats();
                    
                    const syncStatus = deleteResult.synced ? '(Deleted from Firebase)' : '(Deleted locally - will sync when online)';
                    alert(` Shop item deleted successfully! ${syncStatus}`);
                } else {
                    alert(' Failed to delete shop item: ' + (deleteResult.error || 'Unknown error'));
                }
            }
        }

        // ==================== ADMIN UTILITY FUNCTIONS ====================

        async function checkFirebaseHealth() {
            const stats = datastore.getStats();
            
            // Enhanced diagnostic information
            let diagnostics = '';
            
            try {
                // Test basic connectivity
                if (datastore.firebaseEnabled) {
                    const { collection, getDocs } = datastore.firebaseModules;
                    const testCol = collection(datastore.firebaseDb, 'healthCheck');
                    await getDocs(testCol);
                    diagnostics += ' Firebase connection test: PASSED\n';
                } else {
                    diagnostics += ' Firebase connection test: FAILED\n';
                }
            } catch (error) {
                diagnostics += ` Firebase connection test: ERROR - ${error.message}\n`;
            }
            
            const healthReport = `
 FIREBASE & DATASTORE HEALTH REPORT


 Firebase Status: ${stats.firebaseEnabled ? ' Connected & Ready' : ' Unavailable'}
 Local Storage:  Working
 Network: ${stats.isOnline ? ' Online' : ' Offline'}
 Pending Sync: ${stats.pendingSync} items

${diagnostics}

 DATA SUMMARY:
 Libby's Poetry: ${stats.poetryEntries} entries
 Community Poetry: ${stats.userSubmissions} entries  
 Shop Items: ${stats.shopItems} entries
 Settings: ${stats.settings} configurations
 Total Content: ${stats.totalContent} items

 Last Modified: ${new Date(stats.lastModified).toLocaleString()}
 Version: ${stats.version}

 TROUBLESHOOTING:
${!stats.firebaseEnabled ? `
 Firebase is not connected. Possible issues:
1. Check browser console for detailed error messages
2. Verify Firebase project configuration
3. Ensure Firestore is enabled in Firebase Console
4. Check if running on HTTPS (required for Firebase)
5. Verify API keys and project settings
6. Check for browser extensions blocking requests

Running in localStorage-only mode with auto-sync when Firebase reconnects.
` : ' Firebase connected - true multi-storage capability active!'}

 TIP: Open browser console (F12) to see detailed Firebase logs.
            `.trim();
            
            alert(healthReport);
            
            // Also log detailed info to console
            console.log(' FIREBASE HEALTH CHECK');
            console.log('Firebase enabled:', stats.firebaseEnabled);
            console.log('Firebase DB instance:', datastore.firebaseDb);
            console.log('Firebase modules:', datastore.firebaseModules);
            console.log('Sync queue:', datastore.syncQueue);
        }
        
        function exportData() {
            try {
                const exportData = datastore.exportData();
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `poetry-garden-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert(' Data exported successfully!');
            } catch (error) {
                alert(' Export failed: ' + error.message);
            }
        }
        
        function debugCollections() {
            console.log(' =================================');
            console.log(' COLLECTION DEBUG INFORMATION');
            console.log(' =================================');
            
            // Local Storage Data
            console.log(' LOCAL STORAGE DATA:');
            console.log('  poetryEntries:', datastore.data.poetryEntries?.length || 0, 'items');
            console.log('  userSubmissions:', datastore.data.userSubmissions?.length || 0, 'items');
            console.log('  shopItems:', datastore.data.shopItems?.length || 0, 'items');
            
            if (datastore.data.poetryEntries?.length > 0) {
                console.log(' LIBBY\'S POETRY ENTRIES:');
                datastore.data.poetryEntries.forEach((entry, index) => {
                    console.log(`  ${index + 1}. "${entry.title}" by ${entry.author} (ID: ${entry.id})`);
                });
            }
            
            if (datastore.data.userSubmissions?.length > 0) {
                console.log(' COMMUNITY POETRY ENTRIES:');
                datastore.data.userSubmissions.forEach((entry, index) => {
                    console.log(`  ${index + 1}. "${entry.title}" by ${entry.author} (ID: ${entry.id})`);
                });
            }
            
            // Firebase Status
            console.log(' FIREBASE STATUS:');
            console.log('  Enabled:', datastore.firebaseEnabled);
            console.log('  Online:', datastore.isOnline);
            console.log('  Database instance:', !!datastore.firebaseDb);
            console.log('  Modules loaded:', !!datastore.firebaseModules);
            
            // Sync Queue
            console.log(' SYNC QUEUE:');
            console.log('  Pending items:', datastore.syncQueue.length);
            if (datastore.syncQueue.length > 0) {
                datastore.syncQueue.forEach((item, index) => {
                    console.log(`  ${index + 1}. ${item.action}  ${item.collection}/${item.item?.id || item.id}`);
                });
            }
            
            console.log(' =================================');
            
            alert(` Debug information logged to console!\n\nLocalStorage:\n Libby's Poetry: ${datastore.data.poetryEntries?.length || 0} entries\n Community Poetry: ${datastore.data.userSubmissions?.length || 0} entries\n\nFirebase: ${datastore.firebaseEnabled ? 'Connected ' : 'Disconnected '}\nSync Queue: ${datastore.syncQueue.length} pending\n\nCheck browser console (F12) for detailed logs.`);
        }
        
        function clearLocalCollections() {
            if (confirm(' Are you sure you want to clear ALL local data?\n\nThis will:\n Delete all locally stored poetry\n Clear community submissions\n Remove shop items\n Reset settings\n\nThis action cannot be undone!')) {
                try {
                    // Clear localStorage
                    localStorage.removeItem(datastore.storageKey);
                    
                    // Reset datastore to default
                    datastore.data = datastore.getDefaultData();
                    datastore.saveToLocalStorage();
                    
                    // Update UI
                    populateAdminPanel();
                    populateBook();
                    populateLibbyPoetryGrid();
                    populateUserBook();
                    populatePoetryGrid();
                    populateShop();
                    
                    // Update status displays
                    const announcement = datastore.getSetting('announcement');
                    const introText = datastore.getSetting('introText');
                    if (announcement) document.getElementById('announcement').textContent = announcement;
                    if (introText) document.getElementById('intro-text').textContent = introText;
                    
                    console.log(' Local data cleared and reset to defaults');
                    alert(' Local data cleared successfully!\n\nAll collections have been reset to default values. Firebase data is unaffected.');
                    
                } catch (error) {
                    console.error(' Error clearing local data:', error);
                    alert(' Failed to clear local data: ' + error.message);
                }
            }
        }
        
        async function loadFromFirebase() {
            if (!datastore.firebaseEnabled) {
                alert(' Firebase is not connected. Cannot reload from Firebase.');
                return;
            }
            
            try {
                console.log(' Reloading data from Firebase...');
                
                const success = await datastore.loadFromFirebase();
                
                if (success) {
                    // Update all UI components
                    populateAdminPanel();
                    populateBook();
                    populateLibbyPoetryGrid();
                    populateUserBook();
                    populatePoetryGrid();
                    populateShop();
                    
                    console.log(' Data reloaded from Firebase successfully');
                    alert(' Data reloaded from Firebase successfully!\n\nAll collections have been updated with the latest Firebase data.');
                } else {
                    console.log(' No data found in Firebase or failed to load');
                    alert(' No data found in Firebase or failed to load.\n\nThis might be normal if no data has been synced yet.');
                }
                
            } catch (error) {
                console.error(' Error reloading from Firebase:', error);
                alert(' Failed to reload from Firebase: ' + error.message);
            }
        }

        async function testLibbyPoetryWrite() {
            if (!datastore.firebaseEnabled) {
                alert(' Firebase is not connected. Cannot test Libby\'s poetry write operation.');
                return;
            }
            
            try {
                console.log(' Testing Libby\'s Poetry Firebase write operation...');
                
                const testData = {
                    id: 'libby_test_' + Date.now(),
                    title: 'Test Libby Poem',
                    content: 'This is a test poem to verify Libby\'s poetry collection is working with Firebase.\n\nNature calls to me,\nIn whispers of the wind,\nA test of connection.',
                    author: 'Libby Nessworthy',
                    createdAt: Date.now(),
                    modifiedAt: Date.now()
                };
                
                console.log(' Creating test entry in poetryEntries collection:', testData);
                const result = await datastore.create('poetryEntries', testData);
                
                console.log(' Libby\'s Poetry test result:', result);
                
                if (result.success && result.synced) {
                    alert(' Libby\'s Poetry Firebase test SUCCESSFUL!\n\nTest poem was successfully written to the "poetryEntries" collection in Firestore.');
                    
                    // Update admin display
                    populateLibbyPoetryTab();
                    populateBook();
                    populateLibbyPoetryGrid();
                    updateAdminStats();
                    
                    // Clean up test data after 3 seconds
                    setTimeout(async () => {
                        await datastore.delete('poetryEntries', testData.id);
                        populateLibbyPoetryTab();
                        populateBook();
                        populateLibbyPoetryGrid();
                        console.log(' Libby\'s poetry test data cleaned up');
                    }, 3000);
                } else if (result.success && !result.synced) {
                    alert(' Libby\'s Poetry test PARTIAL SUCCESS!\n\nData was saved locally but not synced to Firebase. Check Firebase connection and permissions.');
                    console.warn(' Libby\'s Poetry not synced to Firebase');
                    console.log('Firebase enabled:', datastore.firebaseEnabled);
                    console.log('Online status:', datastore.isOnline);
                    console.log('Sync queue:', datastore.syncQueue);
                } else {
                    alert(' Libby\'s Poetry test FAILED!\n\nError: ' + (result.error || 'Unknown error'));
                    console.error(' Libby\'s Poetry test failed:', result.error);
                }
                
            } catch (error) {
                console.error(' Libby\'s Poetry test error:', error);
                alert(' Libby\'s Poetry test FAILED!\n\nError: ' + error.message);
            }
        }
        
        async function testCommunityPoetryWrite() {
            if (!datastore.firebaseEnabled) {
                alert(' Firebase is not connected. Cannot test Community poetry write operation.');
                return;
            }
            
            try {
                console.log(' Testing Community Poetry Firebase write operation...');
                
                const testData = {
                    id: 'community_test_' + Date.now(),
                    title: 'Test Community Poem',
                    content: 'This is a test poem to verify the community poetry collection is working with Firebase.\n\nWords flow like rivers,\nCommunity voices unite,\nTesting connection.',
                    author: 'Test Community User',
                    createdAt: Date.now(),
                    modifiedAt: Date.now()
                };
                
                console.log(' Creating test entry in userSubmissions collection:', testData);
                const result = await datastore.create('userSubmissions', testData);
                
                console.log(' Community Poetry test result:', result);
                
                if (result.success && result.synced) {
                    alert(' Community Poetry Firebase test SUCCESSFUL!\n\nTest poem was successfully written to the "userSubmissions" collection in Firestore.');
                    
                    // Update displays
                    populateCommunityPoetryTab();
                    populateUserBook();
                    populatePoetryGrid();
                    updateAdminStats();
                    
                    // Clean up test data after 3 seconds
                    setTimeout(async () => {
                        await datastore.delete('userSubmissions', testData.id);
                        populateCommunityPoetryTab();
                        populateUserBook();
                        populatePoetryGrid();
                        console.log(' Community poetry test data cleaned up');
                    }, 3000);
                } else if (result.success && !result.synced) {
                    alert(' Community Poetry test PARTIAL SUCCESS!\n\nData was saved locally but not synced to Firebase. Check Firebase connection and permissions.');
                    console.warn(' Community Poetry not synced to Firebase');
                } else {
                    alert(' Community Poetry test FAILED!\n\nError: ' + (result.error || 'Unknown error'));
                    console.error(' Community Poetry test failed:', result.error);
                }
                
            } catch (error) {
                console.error(' Community Poetry test error:', error);
                alert(' Community Poetry test FAILED!\n\nError: ' + error.message);
            }
        }
        
        async function syncToFirebase() {
            if (!datastore.firebaseEnabled) {
                alert(' Firebase is not available. Cannot sync.');
                return;
            }
            
            try {
                console.log(' Starting manual Firebase sync...');
                await datastore.syncPendingChanges();
                alert(' Manual Firebase sync completed!');
                updateAdminStats();
            } catch (error) {
                console.error(' Sync failed:', error);
                alert(' Sync failed: ' + error.message);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                isLoggedIn = false;
                showPage('intro');
                document.getElementById('admin-username').value = '';
                document.getElementById('admin-password').value = '';
                alert('You have been logged out successfully.');
            }
        }

        // ==================== DEVICE DETECTION AND RESPONSIVE OPTIMIZATION ====================
        
        function detectDeviceAndOptimize() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const body = document.body;
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            // Remove existing device classes
            body.classList.remove('mobile', 'tablet', 'desktop', 'touch-device', 'landscape', 'portrait');
            
            // Device type detection
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent) || width <= 480;
            const isTablet = (/ipad|android|silk|kindle/i.test(userAgent) && !/mobile/i.test(userAgent)) || (width > 480 && width <= 1024);
            const isDesktop = width > 1024 && !isMobile && !isTablet;
            const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
            const isLandscape = width > height;
            
            // Add appropriate classes
            if (isMobile) {
                body.classList.add('mobile');
                console.log(' Mobile device detected');
            } else if (isTablet) {
                body.classList.add('tablet');
                console.log(' Tablet device detected');
            } else {
                body.classList.add('desktop');
                console.log(' Desktop device detected');
            }
            
            if (isTouchDevice) {
                body.classList.add('touch-device');
                console.log(' Touch device detected');
            }
            
            body.classList.add(isLandscape ? 'landscape' : 'portrait');
            
            // Optimize floating elements based on device
            optimizeFloatingElements(isMobile, isTablet);
            
            // Optimize animations for performance on mobile
            if (isMobile || isTablet) {
                optimizeAnimationsForMobile();
            }
            
            // Log device information
            console.log(` Screen: ${width}x${height}, Device: ${isMobile ? 'Mobile' : isTablet ? 'Tablet' : 'Desktop'}, Touch: ${isTouchDevice}, Orientation: ${isLandscape ? 'Landscape' : 'Portrait'}`);
        }
        
        function optimizeFloatingElements(isMobile, isTablet) {
            const floatingElements = document.querySelectorAll('.floating-leaf');
            
            if (isMobile) {
                // Reduce number of floating elements on mobile for better performance
                floatingElements.forEach((element, index) => {
                    if (index > 4) { // Keep only first 5 elements
                        element.style.display = 'none';
                    } else {
                        element.style.animationDuration = '10s'; // Slower animation
                        element.style.opacity = '0.5'; // More subtle
                    }
                });
            } else if (isTablet) {
                // Moderate optimization for tablets
                floatingElements.forEach((element, index) => {
                    if (index > 6) { // Keep only first 7 elements
                        element.style.display = 'none';
                    } else {
                        element.style.animationDuration = '8s';
                        element.style.opacity = '0.6';
                    }
                });
            }
        }
        
        function optimizeAnimationsForMobile() {
            // Disable complex hover animations on mobile
            const style = document.createElement('style');
            style.textContent = `
                @media (max-width: 768px) {
                    * {
                        animation-duration: 0.3s !important;
                        transition-duration: 0.3s !important;
                    }
                    
                    .logo-badge {
                        animation-duration: 12s !important;
                    }
                    
                    .floating-leaf {
                        animation-duration: 15s !important;
                    }
                }
            `;
            document.head.appendChild(style);
            console.log(' Mobile animation optimizations applied');
        }
        
        function handleOrientationChange() {
            // Wait for orientation change to complete
            setTimeout(() => {
                detectDeviceAndOptimize();
                
                // Refresh layout-dependent elements
                if (window.innerWidth <= 768) {
                    const books = document.querySelectorAll('.book.open');
                    books.forEach(book => {
                        book.classList.remove('open');
                        setTimeout(() => book.classList.add('open'), 100);
                    });
                }
                
                console.log(' Orientation changed, layout updated');
            }, 150);
        }
        
        function addTouchOptimizations() {
            // Add touch feedback for better mobile UX
            const touchElements = document.querySelectorAll('.nav-btn, .submit-btn, .add-poetry-btn, .poetry-card, .shop-item, .admin-btn');
            
            touchElements.forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.style.opacity = '0.7';
                }, { passive: true });
                
                element.addEventListener('touchend', function() {
                    this.style.opacity = '';
                }, { passive: true });
                
                element.addEventListener('touchcancel', function() {
                    this.style.opacity = '';
                }, { passive: true });
            });
            
            console.log(' Touch optimizations applied');
        }
        
        function optimizeImagesForDevice() {
            const images = document.querySelectorAll('img');
            const isMobile = document.body.classList.contains('mobile');
            
            images.forEach(img => {
                if (isMobile) {
                    // Enable lazy loading on mobile
                    img.loading = 'lazy';
                    
                    // Optimize image rendering
                    img.style.imageRendering = 'auto';
                }
            });
            
            if (isMobile) {
                console.log(' Image optimizations applied for mobile');
            }
        }
        
        function handleMobileKeyboard() {
            // Handle viewport changes when mobile keyboard appears
            let initialViewportHeight = window.innerHeight;
            
            window.addEventListener('resize', () => {
                const currentHeight = window.innerHeight;
                const heightDifference = initialViewportHeight - currentHeight;
                
                // If height decreased significantly, keyboard is likely open
                if (heightDifference > 150) {
                    document.body.classList.add('keyboard-open');
                    console.log(' Mobile keyboard detected');
                } else {
                    document.body.classList.remove('keyboard-open');
                }
            });
        }
        
        // Add CSS for keyboard handling
        const keyboardStyle = document.createElement('style');
        keyboardStyle.textContent = `
            .keyboard-open .floating-elements {
                display: none;
            }
            
            .keyboard-open .main-content {
                padding-bottom: 2rem;
            }
            
            .keyboard-open .book-container {
                min-height: 300px;
            }
        `;
        document.head.appendChild(keyboardStyle);

        // ==================== INITIALIZATION ====================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log(' Libby\'s Poetry Garden - Firebase Enhanced Version Initializing...');
            console.log(' Debug mode: Detailed Firebase logging enabled');
            console.log(' Current URL:', window.location.href);
            console.log(' Protocol:', window.location.protocol);
            
            // Initialize responsive design
            detectDeviceAndOptimize();
            addTouchOptimizations();
            optimizeImagesForDevice();
            handleMobileKeyboard();
            
            // Listen for orientation and resize changes
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', detectDeviceAndOptimize);
            
            // Wait a moment for datastore to initialize
            setTimeout(() => {
                // Load initial content
                const announcement = datastore.getSetting('announcement');
                const introText = datastore.getSetting('introText');
                
                if (announcement) document.getElementById('announcement').textContent = announcement;
                if (introText) document.getElementById('intro-text').textContent = introText;
                
                console.log(' Initial content loaded');
                console.log(' Firebase status:', datastore.firebaseEnabled ? 'ENABLED' : 'DISABLED');
                console.log(' Local storage status: ENABLED');
                
                if (!datastore.firebaseEnabled) {
                    console.warn(' Firebase not available - running in localStorage-only mode');
                    console.warn(' Check the browser console above for Firebase initialization errors');
                }
            }, 2000); // Increased timeout to allow Firebase more time to initialize
            
            // ==================== FORM EVENT LISTENERS ====================
            
            // Poetry submission form
            document.getElementById('poetry-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const authorName = document.getElementById('poet-name').value;
                const cooldownMinutes = datastore.checkCooldown(authorName);
                
                if (cooldownMinutes > 0) {
                    alert(`Please wait ${cooldownMinutes} minutes before submitting another poem.`);
                    return;
                }
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Submitting...';
                submitBtn.disabled = true;
                
                try {
                    let imageData = null;
                    const imageFile = document.getElementById('poem-image').files[0];
                    if (imageFile) {
                        imageData = await convertImageToBase64(imageFile);
                    }
                    
                    const newEntry = {
                        title: document.getElementById('poem-title').value,
                        content: document.getElementById('poem-content').value,
                        author: authorName,
                        image: imageData
                    };
                    
                    const result = await datastore.create('userSubmissions', newEntry);
                    
                    if (result.success) {
                        datastore.setCooldown(authorName, 5);
                        this.reset();
                        document.getElementById('poem-image-preview').innerHTML = '';
                        
                        populateUserBook();
                        populatePoetryGrid();
                        
                        const syncStatus = result.synced ? '' : ' (Will sync to Firebase when online)';
                        showNotification(
                            'Poetry Submitted! ',
                            `"${result.data.title}" by ${result.data.author} has been added to the Community Collection${syncStatus}`,
                            result.data.id
                        );
                        
                        alert('Your poetry has been submitted successfully! ');
                        checkCooldownDisplay();
                    } else {
                        alert(' Failed to submit poetry: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error submitting poetry:', error);
                    alert(' Failed to submit poetry. Please try again.');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Community poetry form
            document.getElementById('community-poetry-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                console.log(' COMMUNITY POETRY FORM: Starting submission...');
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;
                
                try {
                    let imageData = null;
                    const imageFile = document.getElementById('community-poem-image').files[0];
                    if (imageFile) {
                        console.log(' COMMUNITY POETRY: Converting image to base64...');
                        imageData = await convertImageToBase64(imageFile);
                        console.log(' COMMUNITY POETRY: Image converted successfully');
                    }
                    
                    const newEntry = {
                        title: document.getElementById('community-poem-title').value,
                        content: document.getElementById('community-poem-content').value,
                        author: document.getElementById('community-poet-name').value,
                        image: imageData
                    };
                    
                    console.log(' COMMUNITY POETRY: Entry data prepared:', {
                        title: newEntry.title,
                        author: newEntry.author,
                        hasImage: !!newEntry.image,
                        contentLength: newEntry.content.length
                    });
                    
                    console.log(' COMMUNITY POETRY: Calling datastore.create with "userSubmissions" collection...');
                    const result = await datastore.create('userSubmissions', newEntry);
                    
                    console.log(' COMMUNITY POETRY: Create result:', {
                        success: result.success,
                        synced: result.synced,
                        id: result.data?.id,
                        error: result.error
                    });
                    
                    if (result.success) {
                        console.log(' COMMUNITY POETRY: Entry created successfully!');
                        this.reset();
                        document.getElementById('community-poem-image-preview').innerHTML = '';
                        togglePoetryCreationForm();
                        
                        populateUserBook();
                        populatePoetryGrid();
                        
                        const syncStatus = result.synced ? '(Saved to Firebase )' : '(Saved locally - will sync when online )';
                        showNotification(
                            'Poetry Created! ',
                            `"${result.data.title}" by ${result.data.author} has been added to the Community Collection ${syncStatus}`,
                            result.data.id
                        );
                        
                        alert(' Poetry entry created successfully!');
                        
                        // Additional Firebase verification
                        if (result.synced) {
                            console.log(' COMMUNITY POETRY: Successfully synced to Firebase!');
                        } else {
                            console.warn(' COMMUNITY POETRY: Not synced to Firebase - checking why...');
                            console.log('Firebase enabled:', datastore.firebaseEnabled);
                            console.log('Is online:', datastore.isOnline);
                            console.log('Sync queue length:', datastore.syncQueue.length);
                        }
                    } else {
                        console.error(' COMMUNITY POETRY: Failed to create entry:', result.error);
                        alert(' Failed to create poetry entry: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error(' COMMUNITY POETRY: Exception during submission:', error);
                    alert(' Failed to create poetry entry. Please try again.');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Admin login form
            document.getElementById('admin-login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;
                
                if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                    isLoggedIn = true;
                    alert(' Login successful! Welcome Admin.');
                    showPage('admin-panel');
                } else {
                    alert(' Invalid credentials. Please try again.');
                    document.getElementById('admin-username').value = '';
                    document.getElementById('admin-password').value = '';
                }
            });

            // Admin poetry form
            document.getElementById('admin-poetry-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                console.log(' ADMIN POETRY FORM: Starting submission...');
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;
                
                try {
                    let imageData = null;
                    const imageFile = document.getElementById('admin-poem-image').files[0];
                    if (imageFile) {
                        console.log(' ADMIN POETRY: Converting image to base64...');
                        imageData = await convertImageToBase64(imageFile);
                        console.log(' ADMIN POETRY: Image converted successfully');
                    }
                    
                    const newEntry = {
                        title: document.getElementById('admin-poem-title').value,
                        content: document.getElementById('admin-poem-content').value,
                        author: document.getElementById('admin-poem-author').value,
                        image: imageData
                    };
                    
                    console.log(' ADMIN POETRY: Entry data prepared:', {
                        title: newEntry.title,
                        author: newEntry.author,
                        hasImage: !!newEntry.image,
                        contentLength: newEntry.content.length
                    });
                    
                    console.log(' ADMIN POETRY: Calling datastore.create with "poetryEntries" collection...');
                    const result = await datastore.create('poetryEntries', newEntry);
                    
                    console.log(' ADMIN POETRY: Create result:', {
                        success: result.success,
                        synced: result.synced,
                        id: result.data?.id,
                        error: result.error
                    });
                    
                    if (result.success) {
                        console.log(' ADMIN POETRY: Entry created successfully!');
                        this.reset();
                        document.getElementById('admin-poem-image-preview').innerHTML = '';
                        
                        populateLibbyPoetryTab();
                        populateBook();
                        updateAdminStats();
                        
                        const syncStatus = result.synced ? '(Saved to Firebase )' : '(Saved locally - will sync when online )';
                        alert(` Poetry entry added successfully! ${syncStatus}`);
                        
                        // Additional Firebase verification
                        if (result.synced) {
                            console.log(' ADMIN POETRY: Successfully synced to Firebase!');
                        } else {
                            console.warn(' ADMIN POETRY: Not synced to Firebase - checking why...');
                            console.log('Firebase enabled:', datastore.firebaseEnabled);
                            console.log('Is online:', datastore.isOnline);
                            console.log('Sync queue length:', datastore.syncQueue.length);
                        }
                    } else {
                        console.error(' ADMIN POETRY: Failed to create entry:', result.error);
                        alert(' Failed to add poetry entry: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error(' ADMIN POETRY: Exception during submission:', error);
                    alert(' Failed to add poetry entry. Please try again.');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Shop item form
            document.getElementById('shop-item-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;
                
                try {
                    let imageData = document.getElementById('item-image').value;
                    const imageFile = document.getElementById('item-image-file').files[0];
                    if (imageFile) {
                        imageData = await convertImageToBase64(imageFile);
                    } else if (!imageData) {
                        imageData = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='200' viewBox='0 0 300 200'%3E%3Crect fill='%23f0f0f0' width='300' height='200'/%3E%3Ctext x='50%' y='50%' text-anchor='middle' fill='%23666' font-size='14'%3ENo Image%3C/text%3E%3C/svg%3E";
                    }
                    
                    const newItem = {
                        name: document.getElementById('item-name').value,
                        description: document.getElementById('item-description').value,
                        price: document.getElementById('item-price').value,
                        image: imageData,
                        link: document.getElementById('item-link').value
                    };
                    
                    const result = await datastore.create('shopItems', newItem);
                    
                    if (result.success) {
                        this.reset();
                        document.getElementById('item-image-preview').innerHTML = '';
                        
                        populateShopItemsTab();
                        populateShop();
                        updateAdminStats();
                        
                        const syncStatus = result.synced ? '(Saved to Firebase)' : '(Saved locally - will sync when online)';
                        alert(` Shop item added successfully! ${syncStatus}`);
                    } else {
                        alert(' Failed to add shop item: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error adding shop item:', error);
                    alert(' Failed to add shop item. Please try again.');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // ==================== IMAGE PREVIEW EVENT LISTENERS ====================
            
            document.getElementById('poem-image').addEventListener('change', function(e) {
                handleImagePreview(e, 'poem-image-preview');
            });

            document.getElementById('community-poem-image').addEventListener('change', function(e) {
                handleImagePreview(e, 'community-poem-image-preview');
            });

            document.getElementById('admin-poem-image').addEventListener('change', function(e) {
                handleImagePreview(e, 'admin-poem-image-preview');
            });

            document.getElementById('item-image-file').addEventListener('change', function(e) {
                handleImagePreview(e, 'item-image-preview');
            });

            document.getElementById('poet-name').addEventListener('input', checkCooldownDisplay);
            
            // Initialize floating elements positions
            const leaves = document.querySelectorAll('.floating-leaf');
            leaves.forEach((leaf, index) => {
                const duration = 6 + Math.random() * 4;
                leaf.style.animationDuration = duration + 's';
                
                const currentLeft = parseFloat(leaf.style.left);
                const currentTop = parseFloat(leaf.style.top);
                leaf.style.left = (currentLeft + (Math.random() - 0.5) * 10) + '%';
                leaf.style.top = (currentTop + (Math.random() - 0.5) * 10) + '%';
            });

            console.log(' Firebase-enhanced initialization complete!');
            console.log(' Firebase support enabled with localStorage fallback');
            console.log(' True multi-storage capability active');
        });
    </script>
</body>
</html>             
